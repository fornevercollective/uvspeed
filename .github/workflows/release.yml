# Create GitHub Release + build artifacts on version tags
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build Python package
        run: |
          pip install build
          python -m build
          ls -la dist/

      - name: Create release archive
        run: |
          # Full platform archive (no build artifacts)
          tar czf uvspeed-${{ steps.version.outputs.VERSION }}.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='dist' \
            --exclude='__pycache__' \
            --exclude='.venv' \
            --exclude='*.egg-info' \
            --exclude='src-tauri/target' \
            --exclude='tauri-dist' \
            web/ src/ src-tauri/ icons/ tools/ \
            pyproject.toml package.json Cargo.toml \
            uvspeed_cli.py uvspeed_hexcast.py \
            install.sh launch-hexterm.sh \
            README.md CHANGELOG.md LICENSE \
            .github/ .cursor/

          # Lightweight web-only archive (for PWA/phone deployment)
          tar czf uvspeed-web-${{ steps.version.outputs.VERSION }}.tar.gz \
            web/ icons/favicon.png icons/icon-192.png icons/nyan-banner.png

          # hexcast standalone CLI
          tar czf hexcast-${{ steps.version.outputs.VERSION }}.tar.gz \
            uvspeed_hexcast.py pyproject.toml

      - name: Generate release notes
        id: notes
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log ${PREV_TAG}..HEAD --oneline --no-merges)
          else
            COMMITS=$(git log --oneline --no-merges -20)
          fi
          
          cat > release_notes.md << 'NOTES'
          ## uvspeed v${{ steps.version.outputs.VERSION }}
          
          **beyondBINARY quantum-prefixed development platform**
          
          ### Packages
          
          | Package | Description | Install |
          |---------|-------------|---------|
          | `uvspeed-*.tar.gz` | Full platform (web + CLI + Tauri source) | `tar xzf` then `install.sh` |
          | `uvspeed-web-*.tar.gz` | Web apps only (PWA-ready) | Extract and serve |
          | `hexcast-*.tar.gz` | Hexcast CLI (camera→terminal streaming) | `pip install .` or `uv pip install .` |
          | `*.whl` | Python package (hexcast + bridge) | `pip install *.whl` |
          
          ### Tools Included
          - **hexterm** — full terminal emulator (PWA + Tauri desktop app)
          - **hexcast** — camera-to-terminal video streaming (CLI + web)
          - **kbatch** — keyboard heatmap analyzer with sync
          - **grid view** — multi-stream canvas with device management
          - **quantum-notepad** — beyondBINARY code notepad with 20-language support
          - **brotherNumsy** — endless runner with AI training API
          - **blackwell** — NVIDIA data visualization dashboard
          - **questcast** — Meta Quest broadcast + research
          - **archflow** — n8n-style architecture visualizer
          - **jawta-audio** — spatial audio + Strudel live coding
          - **github-dashboard** — project health dashboard
          
          ### Quick Start
          ```bash
          # Zero-install web (just open in browser)
          open web/quantum-notepad.html
          
          # Python CLI tools
          pip install uvspeed-quantum
          hexcast              # camera → terminal
          hexcast --receive    # receive remote stream
          
          # Tauri desktop app (macOS)
          cd src-tauri && cargo tauri build --bundles app
          
          # Full install
          bash install.sh
          ```
          
          ### Changes
          NOTES
          echo "$COMMITS" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            uvspeed-${{ steps.version.outputs.VERSION }}.tar.gz
            uvspeed-web-${{ steps.version.outputs.VERSION }}.tar.gz
            hexcast-${{ steps.version.outputs.VERSION }}.tar.gz
            dist/*.whl
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Tauri desktop app build (macOS)
  tauri-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Sync web assets
        run: mkdir -p tauri-dist && cp -r web/* tauri-dist/
      - name: Build Tauri app
        run: |
          cargo install tauri-cli
          cd src-tauri && cargo tauri build --bundles app
      - name: Upload Tauri artifact
        uses: actions/upload-artifact@v4
        with:
          name: uvspeed-macos
          path: src-tauri/target/release/bundle/macos/*.app

  # Optional: publish to PyPI (enable when ready)
  # pypi:
  #   needs: release
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with: { python-version: '3.13' }
  #     - run: pip install build twine
  #     - run: python -m build
  #     - run: twine upload dist/*
  #       env:
  #         TWINE_USERNAME: __token__
  #         TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
