# Create GitHub Release + build artifacts on version tags
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Validate Python syntax
        run: python -c "import ast; ast.parse(open('src/01-core/quantum_bridge_server.py').read()); print('bridge server OK')"

      - name: Build Python package
        run: |
          pip install build
          python -m build
          ls -la dist/

      - name: Create release archive
        run: |
          # Create lightweight archive (no node_modules, no .git)
          tar czf uvspeed-${{ steps.version.outputs.VERSION }}.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='dist' \
            --exclude='__pycache__' \
            --exclude='.venv' \
            --exclude='*.egg-info' \
            web/ src/ icons/ \
            pyproject.toml package.json uvspeed_cli.py \
            .cursor/ .github/ .windsurf/ .vscode/ \
            README.md CHANGELOG.md LICENSE CODE_OF_CONDUCT.md CONTRIBUTING.md SECURITY.md .gitignore .gitattributes

      - name: Generate release notes
        id: notes
        run: |
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log ${PREV_TAG}..HEAD --oneline --no-merges)
          else
            COMMITS=$(git log --oneline --no-merges -20)
          fi
          
          cat > release_notes.md << 'NOTES'
          ## uvspeed v${{ steps.version.outputs.VERSION }}
          
          **beyondBINARY quantum-prefixed code architecture**
          
          ### What's Included
          - `web/quantum-notepad.html` — zero-install web notepad
          - `src/01-core/quantum_bridge_server.py` — 55+ API endpoint bridge server
          - `src/01-core/mcp_server.py` — MCP server (10 tools, Cursor/Claude Desktop)
          - `web/brothernumsy.html` — endless runner with AI training API
          - `web/kbatch.html` — keyboard pattern analyzer
          - `web/hexcast.html` — live video hex broadcast
          - `web/blackwell.html` — NVIDIA Blackwell data visualization + deploy targets
          - `web/questcast.html` — Meta Quest broadcast + research tools
          - `web/archflow.html` — n8n-style architecture visualizer
          - `web/jawta-audio.html` — Spatial audio + Strudel live code
          - `web/github-dashboard.html` — GitHub project health dashboard
          - 6 IDE configurations (Cursor, Copilot, VS Code, Windsurf) + MCP
          - 20-language quantum prefix support
          
          ### Install
          ```bash
          # Web (zero install)
          open web/quantum-notepad.html
          
          # Bridge server
          uv run python src/01-core/quantum_bridge_server.py
          
          # Python package
          pip install dist/uvspeed_quantum-*.whl
          ```
          
          ### Changes
          NOTES
          echo "$COMMITS" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            uvspeed-${{ steps.version.outputs.VERSION }}.tar.gz
            dist/*.whl
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: publish to PyPI (enable when ready)
  # pypi:
  #   needs: release
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with: { python-version: '3.13' }
  #     - run: pip install build twine
  #     - run: python -m build
  #     - run: twine upload dist/*
  #       env:
  #         TWINE_USERNAME: __token__
  #         TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
