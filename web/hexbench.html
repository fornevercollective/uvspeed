<!-- beyondBINARY quantum-prefixed | uvspeed | {+1, 1, -1, +0, 0, -0, +n, n, -n} -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hexbench â€” Voltage Lab | Power Supply + Electronics Workbench</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../icons/hexterm-favicon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
    <style>
        :root {
            --bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--bg4:#2d333b;
            --border:#30363d;--border-m:#484f58;--text:#e6edf3;--text-m:#8b949e;--text-s:#c9d1d9;
            --accent:#58a6ff;--accent-s:rgba(88,166,255,.15);--green:#3fb950;--orange:#f0883e;
            --red:#f85149;--purple:#a78bfa;--cyan:#56d4dd;--yellow:#ffe138;
            --sp-xs:4px;--sp-sm:8px;--sp-md:16px;--sp-lg:24px;--rad:6px;
            --mono:'SF Mono','Fira Code','JetBrains Mono','Cascadia Code',monospace;
        }
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%;overflow:hidden;touch-action:manipulation}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}
        a{color:var(--accent);text-decoration:none}a:hover{text-decoration:underline}
        ::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

        .app{display:flex;flex-direction:column;height:100vh}

        /* Rainbow bar */
        .rainbow{display:flex;height:2px;width:100%;flex-shrink:0}
        .rainbow span{flex:1}
        .r1{background:#ff3838}.r2{background:#ff8c38}.r3{background:#ffe138}.r4{background:#3fb950}.r5{background:#38a5ff}.r6{background:#bc8cff}

        /* Header */
        .hdr{background:var(--bg2);border-bottom:1px solid var(--border);padding:var(--sp-sm) var(--sp-lg);display:flex;align-items:center;justify-content:space-between;gap:var(--sp-md);flex-shrink:0;min-height:44px}
        .hdr-title{display:flex;align-items:center;gap:var(--sp-sm);font-size:.9375rem;font-weight:600;white-space:nowrap}
        .hdr-logo{height:22px;width:auto;border-radius:4px;filter:drop-shadow(0 0 4px rgba(88,166,255,.3))}
        .hdr-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(255,225,56,.12);border:1px solid var(--yellow);color:var(--yellow);border-radius:10px;padding:2px 8px;font-size:.5625rem;font-weight:600}
        .hdr-nav{display:flex;align-items:center;gap:4px;font-size:.6875rem;flex-wrap:wrap}
        .hdr-nav a{padding:2px 7px;border-radius:var(--rad);background:var(--bg3);border:1px solid var(--border);color:var(--text-m);transition:all .15s}
        .hdr-nav a:hover{color:var(--accent);border-color:var(--accent);text-decoration:none}

        /* Main 3-panel layout */
        .main{flex:1;display:flex;overflow:hidden}
        .panel-resize{width:4px;background:var(--border);cursor:col-resize;flex-shrink:0;transition:background .15s}
        .panel-resize:hover,.panel-resize.active{background:var(--accent)}

        /* Left: Doc / Parts / Code */
        .doc-panel{width:42%;min-width:280px;display:flex;flex-direction:column;background:var(--bg);overflow:hidden}
        .doc-toolbar{display:flex;align-items:center;gap:4px;padding:6px 12px;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0;flex-wrap:wrap}
        .doc-tab{padding:3px 10px;font-size:.625rem;font-weight:600;border:1px solid var(--border);border-radius:var(--rad);background:var(--bg3);color:var(--text-m);cursor:pointer;transition:all .15s}
        .doc-tab:hover{color:var(--text)}
        .doc-tab.active{background:var(--accent-s);color:var(--accent);border-color:var(--accent)}
        .doc-edit-wrap{flex:1;overflow:hidden;display:flex;flex-direction:column}
        .doc-editor{flex:1;padding:16px 20px;font-family:var(--mono);font-size:.8125rem;line-height:1.7;color:var(--text-s);background:var(--bg);border:none;resize:none;outline:none;overflow-y:auto;tab-size:4}
        .doc-rendered{flex:1;padding:16px 20px;overflow-y:auto;display:none}
        .doc-rendered h1{font-size:1.375rem;font-weight:700;color:var(--text);margin:0 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
        .doc-rendered h2{font-size:1.0625rem;font-weight:700;color:var(--text);margin:20px 0 8px}
        .doc-rendered h3{font-size:.875rem;font-weight:700;color:var(--accent);margin:16px 0 6px}
        .doc-rendered p{margin:0 0 10px;font-size:.8125rem;color:var(--text-s);line-height:1.7}
        .doc-rendered code{background:var(--bg3);padding:1px 5px;border-radius:3px;font-family:var(--mono);font-size:.75rem;color:var(--green)}
        .doc-rendered pre{background:var(--bg2);border:1px solid var(--border);border-radius:var(--rad);padding:12px;margin:8px 0 12px;overflow-x:auto}
        .doc-rendered pre code{background:transparent;padding:0;color:var(--text-s);font-size:.6875rem;line-height:1.6}
        .doc-rendered table{width:100%;border-collapse:collapse;font-size:.6875rem;margin:8px 0 12px}
        .doc-rendered th{text-align:left;padding:4px 8px;background:var(--bg3);border:1px solid var(--border);color:var(--accent);font-weight:700}
        .doc-rendered td{padding:4px 8px;border:1px solid var(--border);color:var(--text-s)}
        .doc-rendered strong{color:var(--text);font-weight:700}
        .doc-rendered em{color:var(--orange)}
        .doc-rendered blockquote{border-left:3px solid var(--yellow);padding:4px 12px;margin:8px 0;background:rgba(255,225,56,.06);color:var(--text-m);font-size:.8125rem}
        .doc-rendered ul,.doc-rendered ol{margin:4px 0 10px 20px;font-size:.8125rem}
        .doc-rendered li{margin:2px 0;color:var(--text-s)}
        .doc-rendered hr{border:none;border-top:1px solid var(--border);margin:16px 0}
        .doc-status{display:flex;align-items:center;gap:6px;padding:4px 12px;border-top:1px solid var(--border);background:var(--bg2);font-size:.5625rem;color:var(--text-m);flex-shrink:0}

        /* Supplier Panel (hidden until tab switch) */
        .supplier-panel{flex:1;overflow-y:auto;padding:12px;display:none}
        .supplier-panel.active{display:block}
        .supplier-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--rad);padding:10px;margin-bottom:8px;cursor:pointer;transition:all .15s}
        .supplier-card:hover{border-color:var(--accent);background:var(--bg3)}
        .supplier-card .s-name{font-weight:700;font-size:.8125rem;color:var(--text);display:flex;align-items:center;gap:6px}
        .supplier-card .s-url{font-size:.625rem;color:var(--accent);font-family:var(--mono)}
        .supplier-card .s-desc{font-size:.6875rem;color:var(--text-m);margin-top:4px}
        .supplier-search{width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:var(--rad);color:var(--text);font-family:var(--mono);font-size:.75rem;outline:none;margin-bottom:8px}
        .supplier-search:focus{border-color:var(--accent)}

        /* Arduino Code Panel */
        .code-panel{flex:1;overflow:hidden;display:none;flex-direction:column}
        .code-panel.active{display:flex}
        .code-toolbar{display:flex;align-items:center;gap:4px;padding:6px 10px;border-bottom:1px solid var(--border);background:var(--bg2)}
        .code-toolbar button{padding:3px 10px;font-size:.625rem;font-weight:600;border:1px solid var(--border);border-radius:var(--rad);background:var(--bg3);color:var(--text-m);cursor:pointer;transition:all .15s}
        .code-toolbar button:hover{color:var(--green);border-color:var(--green)}
        .code-toolbar button.active-btn{color:var(--green);border-color:var(--green);background:rgba(63,185,80,.1)}
        .code-editor{flex:1;padding:12px;font-family:var(--mono);font-size:.75rem;line-height:1.8;color:var(--green);background:var(--bg);border:none;resize:none;outline:none;overflow-y:auto;tab-size:4}
        .code-output{height:120px;min-height:60px;border-top:1px solid var(--border);overflow-y:auto;padding:8px 12px;font-family:var(--mono);font-size:.6875rem;color:var(--text-m);background:var(--bg2)}

        /* Right: Workbench Canvas */
        .canvas-panel{flex:1;min-width:300px;display:flex;flex-direction:column;overflow:hidden;position:relative}
        .canvas-toolbar{display:flex;align-items:center;gap:4px;padding:6px 10px;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0;flex-wrap:wrap}
        .canvas-area{flex:1;position:relative;overflow:hidden;background:var(--bg)}
        .canvas-grid{position:absolute;inset:0;pointer-events:none;background-image:radial-gradient(circle,var(--border) .5px,transparent .5px);background-size:24px 24px;opacity:.4}
        .canvas-scroll{position:absolute;inset:0;overflow:hidden;cursor:grab}
        .canvas-scroll:active{cursor:grabbing}
        .canvas-inner{min-width:2400px;min-height:1600px;position:relative;padding:40px;transform-origin:0 0}
        .zoom-controls{position:absolute;bottom:12px;right:12px;display:flex;gap:4px;z-index:20}
        .zoom-controls button{background:var(--bg2);border:1px solid var(--border);color:var(--text);width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
        .zoom-controls button:hover{background:var(--accent);color:#fff}
        .zoom-label{background:var(--bg2);border:1px solid var(--border);color:var(--text-m);padding:2px 8px;border-radius:6px;font-size:11px;display:flex;align-items:center}

        /* Nodes */
        .node{position:absolute;background:var(--bg2);border:2px solid var(--border);border-radius:10px;min-width:160px;box-shadow:0 4px 16px rgba(0,0,0,.3);cursor:move;user-select:none;transition:box-shadow .15s,border-color .15s;z-index:1}
        .node:hover{box-shadow:0 6px 24px rgba(0,0,0,.5);border-color:var(--accent)}
        .node.selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(88,166,255,.25)}
        .node.action-node{border-style:dashed}
        .node.action-node.running{border-color:var(--orange);animation:pulse-border 1s ease infinite}
        .node.action-node.done{border-color:var(--green);border-style:solid}
        .node.action-node.error{border-color:var(--red);border-style:solid}
        @keyframes pulse-border{0%,100%{box-shadow:0 0 0 0 rgba(240,136,62,.4)}50%{box-shadow:0 0 0 6px rgba(240,136,62,0)}}
        .node-hdr{padding:6px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;border-radius:8px 8px 0 0}
        .node-icon{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.8125rem;flex-shrink:0}
        .node-name{font-size:.75rem;font-weight:600}
        .node-sub{font-size:.5rem;color:var(--text-m)}
        .node-body{padding:6px 10px;font-size:.625rem}
        .node-ports{display:flex;flex-direction:column;gap:2px}
        .node-port{display:flex;align-items:center;gap:4px;padding:1px 0;font-family:var(--mono);font-size:.5rem;color:var(--text-m)}
        .port-dot{width:7px;height:7px;border-radius:50%;border:2px solid var(--border);background:var(--bg);flex-shrink:0;cursor:crosshair}
        .port-dot.connected{background:var(--green);border-color:var(--green)}
        .port-dot.out{margin-left:auto}
        .node-action-bar{padding:4px 8px;border-top:1px solid var(--border);display:flex;gap:3px}
        .node-run-btn{flex:1;padding:2px 4px;font-size:.5rem;font-weight:700;border:1px solid var(--border);border-radius:3px;background:var(--bg3);color:var(--green);cursor:pointer;transition:all .15s}
        .node-run-btn:hover{background:var(--green);color:#fff;border-color:var(--green)}

        /* Connections SVG */
        .connections-svg{position:absolute;inset:0;pointer-events:none;z-index:0}
        .conn-path{fill:none;stroke:var(--border);stroke-width:2;transition:stroke .15s}
        .conn-path.active{stroke:var(--green);stroke-width:2;filter:drop-shadow(0 0 3px rgba(63,185,80,.3))}

        /* Palette chips */
        .pal-chip{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;font-size:.5625rem;font-weight:600;border:1px solid var(--border);border-radius:var(--rad);background:var(--bg3);color:var(--text-m);cursor:pointer;transition:all .12s;white-space:nowrap}
        .pal-chip:hover{border-color:var(--accent);color:var(--accent)}
        .pal-chip.action{border-color:var(--orange);color:var(--orange);background:rgba(240,136,62,.08)}

        /* PSU Live Monitor */
        .psu-monitor{background:var(--bg2);border:1px solid var(--border);border-radius:var(--rad);padding:10px;margin:8px 0}
        .psu-monitor .psu-title{font-size:.75rem;font-weight:700;color:var(--yellow);margin-bottom:6px;display:flex;align-items:center;gap:6px}
        .psu-row{display:flex;gap:8px;margin:4px 0}
        .psu-val{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:var(--rad);padding:6px 8px;text-align:center}
        .psu-val .psu-num{font-family:var(--mono);font-size:1.5rem;font-weight:700;color:var(--green);letter-spacing:1px}
        .psu-val .psu-unit{font-size:.5625rem;color:var(--text-m)}
        .psu-val .psu-label{font-size:.5rem;color:var(--text-m);margin-top:2px}
        .psu-slider{width:100%;-webkit-appearance:none;height:4px;border-radius:2px;background:var(--border);outline:none;margin:6px 0}
        .psu-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--yellow);cursor:pointer;border:2px solid var(--bg)}

        /* Bottom: Console */
        .console-panel{height:140px;min-height:80px;border-top:1px solid var(--border);background:var(--bg2);display:flex;flex-direction:column;flex-shrink:0}
        .console-resize{height:4px;background:var(--border);cursor:row-resize;flex-shrink:0;transition:background .15s}
        .console-resize:hover,.console-resize.active{background:var(--accent)}
        .console-log{flex:1;overflow-y:auto;padding:6px 12px;font-family:var(--mono);font-size:.6875rem;line-height:1.5}
        .console-log .log-line{display:flex;gap:8px;padding:1px 0}
        .console-log .log-ts{color:var(--text-m);flex-shrink:0;min-width:60px;font-size:.5625rem}
        .console-log .log-tag{font-weight:700;flex-shrink:0;min-width:50px;font-size:.5625rem}
        .console-log .log-msg{color:var(--text-s);word-break:break-word}
        .console-input{display:flex;border-top:1px solid var(--border);flex-shrink:0}
        .console-input input{flex:1;background:var(--bg);border:none;padding:6px 12px;color:var(--text);font-family:var(--mono);font-size:.75rem;outline:none}
        .console-input button{padding:6px 14px;background:var(--yellow);border:none;color:var(--bg);font-size:.6875rem;font-weight:600;cursor:pointer}

        /* Footer */
        .ftr{background:var(--bg2);border-top:1px solid var(--border);padding:3px var(--sp-lg);display:flex;align-items:center;gap:8px;font-size:.5625rem;color:var(--text-m);flex-shrink:0}
        .rainbow-bottom{display:flex;height:2px;width:100%;flex-shrink:0}
        .rainbow-bottom span{flex:1}

        @media(max-width:900px){.doc-panel{width:35%;min-width:220px}}
        @media(max-width:600px){
            .main{flex-direction:column}
            .doc-panel{width:100%;height:40%}
            .panel-resize{display:none}
        }
    </style>
</head>
<body>
<div class="rainbow"><span class="r1"></span><span class="r2"></span><span class="r3"></span><span class="r4"></span><span class="r5"></span><span class="r6"></span></div>
<div class="app">
    <!-- Header -->
    <div class="hdr">
        <div class="hdr-title">
            <img src="../icons/hexterm-192.png" alt="hexbench" class="hdr-logo">
            hexbench
            <span class="hdr-badge">Voltage Lab</span>
        </div>
        <div class="hdr-nav">
            <a href="quantum-notepad.html">Notepad</a>
            <a href="research-lab.html">Research</a>
            <a href="terminal.html">hexterm</a>
            <a href="hexcast.html">hexcast</a>
            <a href="archflow.html">archflow</a>
            <a href="github-dashboard.html">Dashboard</a>
        </div>
    </div>

    <!-- Main: Doc/Parts/Code + Workbench Canvas -->
    <div class="main">
        <!-- Left Panel -->
        <div class="doc-panel" id="doc-panel">
            <div class="doc-toolbar">
                <button class="doc-tab active" data-view="bench" id="tab-bench">Bench</button>
                <button class="doc-tab" data-view="parts" id="tab-parts">Parts</button>
                <button class="doc-tab" data-view="code" id="tab-code">Code</button>
                <button class="doc-tab" data-view="suppliers" id="tab-suppliers">Suppliers</button>
                <span style="flex:1"></span>
                <button class="doc-tab" id="doc-save" style="color:var(--green);border-color:var(--green)">Save</button>
                <button class="doc-tab" id="doc-export">Export</button>
            </div>

            <!-- Bench View (default) -->
            <div class="doc-edit-wrap" id="view-bench">
                <div class="doc-rendered" id="bench-rendered" style="display:block"></div>
            </div>

            <!-- Parts List -->
            <div class="supplier-panel" id="view-parts">
                <input class="supplier-search" id="parts-search" placeholder="Search parts...">
                <div id="parts-list"></div>
            </div>

            <!-- Code Editor -->
            <div class="code-panel" id="view-code">
                <div class="code-toolbar">
                    <span style="font-size:.625rem;font-weight:700;color:var(--green)">Arduino / C++</span>
                    <span style="flex:1"></span>
                    <button id="code-verify">Verify</button>
                    <button id="code-upload">Upload</button>
                    <button id="code-stream">Stream to hexterm</button>
                    <button id="code-template">Templates</button>
                </div>
                <textarea class="code-editor" id="code-editor" spellcheck="false"></textarea>
                <div class="code-output" id="code-output"></div>
            </div>

            <!-- Suppliers -->
            <div class="supplier-panel" id="view-suppliers">
                <input class="supplier-search" id="supplier-search" placeholder="Search suppliers, components, datasheets...">
                <div id="supplier-list"></div>
            </div>

            <div class="doc-status">
                <span id="doc-status-text">hexbench ready</span>
                <span style="flex:1"></span>
                <span style="color:var(--yellow)">AT6301 60V/10A/300W</span>
            </div>
        </div>

        <!-- Resize Handle -->
        <div class="panel-resize" id="panel-resize"></div>

        <!-- Right: Workbench Canvas -->
        <div class="canvas-panel" id="canvas-panel">
            <div class="canvas-toolbar">
                <span style="font-size:.625rem;font-weight:700;color:var(--yellow);margin-right:4px">WORKBENCH</span>
                <span class="pal-chip" data-type="psu">PSU</span>
                <span class="pal-chip" data-type="multimeter">Multimeter</span>
                <span class="pal-chip" data-type="oscilloscope">Scope</span>
                <span class="pal-chip" data-type="arduino">Arduino</span>
                <span class="pal-chip" data-type="esp32">ESP32</span>
                <span class="pal-chip" data-type="raspberry">RPi</span>
                <span class="pal-chip" data-type="sensor">Sensor</span>
                <span class="pal-chip" data-type="led">LED</span>
                <span class="pal-chip" data-type="motor">Motor</span>
                <span class="pal-chip" data-type="relay">Relay</span>
                <span style="opacity:.3;margin:0 2px">|</span>
                <span class="pal-chip action" data-type="measure">Measure</span>
                <span class="pal-chip action" data-type="calculate">Calculate</span>
                <span class="pal-chip action" data-type="stream">Stream</span>
                <span style="flex:1"></span>
                <span class="pal-chip" id="preset-at6301" style="color:var(--yellow);border-color:var(--yellow)">AT6301 Setup</span>
                <span class="pal-chip" id="preset-arduino" style="color:var(--green);border-color:var(--green)">Arduino Lab</span>
                <span class="pal-chip" id="preset-clear" style="color:var(--red);border-color:var(--red)">Clear</span>
            </div>
            <div class="canvas-area">
                <div class="canvas-grid" id="canvas-grid"></div>
                <div class="canvas-scroll" id="canvas-scroll">
                    <div class="canvas-inner" id="canvas-inner">
                        <svg class="connections-svg" id="connections-svg"></svg>
                    </div>
                </div>
                <div class="zoom-controls">
                    <button id="zoom-in" title="Zoom in">+</button>
                    <span class="zoom-label" id="zoom-label">100%</span>
                    <button id="zoom-out" title="Zoom out">âˆ’</button>
                    <button id="zoom-fit" title="Fit all">âŠ™</button>
                    <button id="zoom-reset" title="Reset">1:1</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Console Resize -->
    <div class="console-resize" id="console-resize"></div>

    <!-- Bottom: Console -->
    <div class="console-panel" id="console-panel">
        <div class="console-log" id="console-log"></div>
        <div class="console-input">
            <input type="text" id="console-input" placeholder="hexbench console â€” /help for commands" autocomplete="off">
            <button id="console-send">Send</button>
        </div>
    </div>

    <!-- Footer -->
    <div class="ftr">
        <span style="color:var(--yellow)">hexbench</span><span style="opacity:.3">|</span>
        <span style="font-family:var(--mono)" id="ftr-nodes">0 nodes</span><span style="opacity:.3">|</span>
        <span style="font-family:var(--mono)" id="ftr-conns">0 connections</span><span style="opacity:.3">|</span>
        <span style="font-family:var(--mono)">{+1, 1, -1, +0, 0, -0, +n, n, -n}</span>
        <span style="flex:1"></span>
        <a href="quantum-notepad.html" style="font-size:.5625rem">Notepad</a>
        <span style="color:var(--purple);font-family:var(--mono)">beyondBINARY</span>
    </div>
</div>
<div class="rainbow-bottom"><span class="r1"></span><span class="r2"></span><span class="r3"></span><span class="r4"></span><span class="r5"></span><span class="r6"></span></div>

<script>
(function(){
'use strict';
const $=id=>document.getElementById(id);

// ===== VIEW SWITCHING =====
let activeView = 'bench';
const views = { bench: $('view-bench'), parts: $('view-parts'), code: $('view-code'), suppliers: $('view-suppliers') };

function switchView(name) {
    activeView = name;
    Object.entries(views).forEach(([k, el]) => {
        if (el) { el.style.display = k === name ? (k === 'code' ? 'flex' : (k === 'bench' ? 'flex' : 'block')) : 'none'; }
        if (k === 'bench' && el) el.style.flexDirection = 'column';
    });
    document.querySelectorAll('.doc-tab[data-view]').forEach(t => {
        t.classList.toggle('active', t.dataset.view === name);
    });
}

document.querySelectorAll('.doc-tab[data-view]').forEach(t => {
    t.addEventListener('click', () => switchView(t.dataset.view));
});

// ===== BENCH VIEW (PSU Monitor + Freya Calculator) =====
const AT6301 = {
    name: 'Abestop AT6301',
    maxV: 60, maxA: 10, maxW: 300,
    resolution: { v: 0.01, a: 0.001 },
    usb: '5V/1A',
    memories: 4,
    features: ['OVP','OCP','CV/CC','Waveform Output','SCPI USB','Temperature Fan Control','4-digit LCD'],
    url: 'https://abestop.com/products/abestop-at6301'
};

let psuVoltage = 5.00, psuCurrent = 1.000, psuOutput = false;

function renderBench() {
    const power = (psuVoltage * psuCurrent).toFixed(2);
    const resistance = psuCurrent > 0 ? (psuVoltage / psuCurrent).toFixed(2) : 'âˆž';
    $('bench-rendered').innerHTML = `
        <div class="psu-monitor">
            <div class="psu-title">âš¡ ${AT6301.name} â€” DC Power Supply <span style="font-size:.5rem;color:var(--text-m);font-weight:400">${AT6301.maxV}V/${AT6301.maxA}A/${AT6301.maxW}W</span></div>
            <div class="psu-row">
                <div class="psu-val"><div class="psu-num" style="color:var(--yellow)">${psuVoltage.toFixed(2)}</div><div class="psu-unit">V</div><div class="psu-label">Voltage</div></div>
                <div class="psu-val"><div class="psu-num" style="color:var(--green)">${psuCurrent.toFixed(3)}</div><div class="psu-unit">A</div><div class="psu-label">Current</div></div>
                <div class="psu-val"><div class="psu-num" style="color:var(--orange)">${power}</div><div class="psu-unit">W</div><div class="psu-label">Power</div></div>
                <div class="psu-val"><div class="psu-num" style="color:var(--cyan)">${resistance}</div><div class="psu-unit">Î©</div><div class="psu-label">Load R</div></div>
            </div>
            <div style="margin-top:8px;display:flex;align-items:center;gap:8px">
                <span style="font-size:.625rem;color:var(--text-m);min-width:55px">Voltage:</span>
                <input type="range" class="psu-slider" id="psu-v-slider" min="0" max="${AT6301.maxV}" step="0.01" value="${psuVoltage}" style="flex:1">
                <input type="number" id="psu-v-input" value="${psuVoltage}" min="0" max="${AT6301.maxV}" step="0.01" style="width:60px;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:2px 4px;color:var(--yellow);font-family:var(--mono);font-size:.75rem;text-align:right">
            </div>
            <div style="display:flex;align-items:center;gap:8px;margin-top:4px">
                <span style="font-size:.625rem;color:var(--text-m);min-width:55px">Current:</span>
                <input type="range" class="psu-slider" id="psu-a-slider" min="0" max="${AT6301.maxA}" step="0.001" value="${psuCurrent}" style="flex:1">
                <input type="number" id="psu-a-input" value="${psuCurrent}" min="0" max="${AT6301.maxA}" step="0.001" style="width:60px;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:2px 4px;color:var(--green);font-family:var(--mono);font-size:.75rem;text-align:right">
            </div>
            <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
                <button onclick="togglePSU()" id="psu-toggle" style="padding:4px 16px;border-radius:4px;font-size:.6875rem;font-weight:700;border:1px solid ${psuOutput?'var(--red)':'var(--green)'};background:${psuOutput?'rgba(248,81,73,.1)':'rgba(63,185,80,.1)'};color:${psuOutput?'var(--red)':'var(--green)'};cursor:pointer">${psuOutput?'OUTPUT OFF':'OUTPUT ON'}</button>
                <button onclick="setPSUPreset(3.3,0.5)" style="padding:4px 8px;border-radius:4px;font-size:.5625rem;border:1px solid var(--border);background:var(--bg3);color:var(--text-m);cursor:pointer">3.3V</button>
                <button onclick="setPSUPreset(5,1)" style="padding:4px 8px;border-radius:4px;font-size:.5625rem;border:1px solid var(--border);background:var(--bg3);color:var(--text-m);cursor:pointer">5V/1A</button>
                <button onclick="setPSUPreset(12,2)" style="padding:4px 8px;border-radius:4px;font-size:.5625rem;border:1px solid var(--border);background:var(--bg3);color:var(--text-m);cursor:pointer">12V/2A</button>
                <button onclick="setPSUPreset(24,5)" style="padding:4px 8px;border-radius:4px;font-size:.5625rem;border:1px solid var(--border);background:var(--bg3);color:var(--text-m);cursor:pointer">24V/5A</button>
                <button onclick="setPSUPreset(48,3)" style="padding:4px 8px;border-radius:4px;font-size:.5625rem;border:1px solid var(--border);background:var(--bg3);color:var(--text-m);cursor:pointer">48V/3A</button>
                <a href="${AT6301.url}" target="_blank" style="padding:4px 8px;border-radius:4px;font-size:.5625rem;border:1px solid var(--yellow);background:rgba(255,225,56,.08);color:var(--yellow);text-decoration:none;cursor:pointer">Product Page â†—</a>
            </div>
        </div>
        <h3 style="color:var(--cyan);font-size:.8125rem;margin:12px 0 6px">âš¡ Freya Unit Calculator</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
            <div class="psu-monitor" style="margin:0">
                <div style="font-size:.625rem;color:var(--text-m);margin-bottom:4px">Ohm's Law: V = I Ã— R</div>
                <div style="display:flex;gap:4px">
                    <input id="calc-v" placeholder="V" style="flex:1;padding:4px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--yellow);font-family:var(--mono);font-size:.75rem">
                    <input id="calc-i" placeholder="A" style="flex:1;padding:4px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--green);font-family:var(--mono);font-size:.75rem">
                    <input id="calc-r" placeholder="Î©" style="flex:1;padding:4px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--cyan);font-family:var(--mono);font-size:.75rem">
                </div>
                <button onclick="calcOhm()" style="margin-top:4px;padding:3px 8px;font-size:.5625rem;border:1px solid var(--accent);border-radius:4px;background:var(--accent-s);color:var(--accent);cursor:pointer;width:100%">Calculate</button>
                <div id="calc-result" style="font-family:var(--mono);font-size:.6875rem;color:var(--text-s);margin-top:4px"></div>
            </div>
            <div class="psu-monitor" style="margin:0">
                <div style="font-size:.625rem;color:var(--text-m);margin-bottom:4px">Power: P = V Ã— I</div>
                <div style="display:flex;gap:4px">
                    <input id="calc-pv" placeholder="V" style="flex:1;padding:4px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--yellow);font-family:var(--mono);font-size:.75rem">
                    <input id="calc-pi" placeholder="A" style="flex:1;padding:4px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--green);font-family:var(--mono);font-size:.75rem">
                    <input id="calc-pp" placeholder="W" style="flex:1;padding:4px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--orange);font-family:var(--mono);font-size:.75rem">
                </div>
                <button onclick="calcPower()" style="margin-top:4px;padding:3px 8px;font-size:.5625rem;border:1px solid var(--accent);border-radius:4px;background:var(--accent-s);color:var(--accent);cursor:pointer;width:100%">Calculate</button>
                <div id="calc-presult" style="font-family:var(--mono);font-size:.6875rem;color:var(--text-s);margin-top:4px"></div>
            </div>
        </div>
        <h3 style="color:var(--text-m);font-size:.75rem;margin:12px 0 6px">Device Specs</h3>
        <div style="font-size:.6875rem;color:var(--text-s);line-height:1.8;font-family:var(--mono)">
            <div>Model: <span style="color:var(--yellow)">${AT6301.name}</span></div>
            <div>Output: <span style="color:var(--text)">0~${AT6301.maxV}V / 0~${AT6301.maxA}A</span></div>
            <div>Power: <span style="color:var(--orange)">${AT6301.maxW}W</span> (constant power design)</div>
            <div>Resolution: <span style="color:var(--cyan)">${AT6301.resolution.v}V / ${AT6301.resolution.a}A</span></div>
            <div>USB: <span style="color:var(--text)">${AT6301.usb}</span></div>
            <div>Memory: <span style="color:var(--text)">${AT6301.memories} groups (M1-M4)</span></div>
            <div>Interface: <span style="color:var(--accent)">USB (SCPI protocol)</span></div>
            <div>Waveform: <span style="color:var(--text)">10 editable points per waveform</span></div>
            <div>Features: ${AT6301.features.map(f => `<span style="display:inline-block;padding:1px 5px;background:var(--bg3);border-radius:3px;margin:1px;font-size:.5625rem">${f}</span>`).join('')}</div>
        </div>
    `;
    // Bind slider events
    const vs = $('psu-v-slider'), vi = $('psu-v-input'), as = $('psu-a-slider'), ai = $('psu-a-input');
    if (vs) { vs.oninput = () => { psuVoltage = parseFloat(vs.value); renderBench(); }; }
    if (vi) { vi.onchange = () => { psuVoltage = Math.min(AT6301.maxV, Math.max(0, parseFloat(vi.value)||0)); renderBench(); }; }
    if (as) { as.oninput = () => { psuCurrent = parseFloat(as.value); renderBench(); }; }
    if (ai) { ai.onchange = () => { psuCurrent = Math.min(AT6301.maxA, Math.max(0, parseFloat(ai.value)||0)); renderBench(); }; }
}

window.togglePSU = function() {
    psuOutput = !psuOutput;
    logConsole('psu', psuOutput ? `OUTPUT ON: ${psuVoltage.toFixed(2)}V / ${psuCurrent.toFixed(3)}A` : 'OUTPUT OFF');
    renderBench();
};

window.setPSUPreset = function(v, a) {
    psuVoltage = v; psuCurrent = a;
    logConsole('psu', `Preset: ${v}V / ${a}A`);
    renderBench();
};

window.calcOhm = function() {
    const v = parseFloat($('calc-v')?.value), i = parseFloat($('calc-i')?.value), r = parseFloat($('calc-r')?.value);
    const el = $('calc-result'); if (!el) return;
    if (!isNaN(v) && !isNaN(i)) el.textContent = `R = ${(v/i).toFixed(4)} Î©, P = ${(v*i).toFixed(4)} W`;
    else if (!isNaN(v) && !isNaN(r)) el.textContent = `I = ${(v/r).toFixed(4)} A, P = ${(v*v/r).toFixed(4)} W`;
    else if (!isNaN(i) && !isNaN(r)) el.textContent = `V = ${(i*r).toFixed(4)} V, P = ${(i*i*r).toFixed(4)} W`;
    else el.textContent = 'Enter any two values';
};

window.calcPower = function() {
    const v = parseFloat($('calc-pv')?.value), i = parseFloat($('calc-pi')?.value), p = parseFloat($('calc-pp')?.value);
    const el = $('calc-presult'); if (!el) return;
    if (!isNaN(v) && !isNaN(i)) el.textContent = `P = ${(v*i).toFixed(4)} W, R = ${(v/i).toFixed(4)} Î©`;
    else if (!isNaN(v) && !isNaN(p)) el.textContent = `I = ${(p/v).toFixed(4)} A, R = ${(v*v/p).toFixed(4)} Î©`;
    else if (!isNaN(i) && !isNaN(p)) el.textContent = `V = ${(p/i).toFixed(4)} V, R = ${(p/(i*i)).toFixed(4)} Î©`;
    else el.textContent = 'Enter any two values';
};

renderBench();

// ===== PARTS LIST =====
const parts = [
    { name:'Abestop AT6301', cat:'PSU', desc:'60V/10A/300W DC bench supply, SCPI USB, 4-digit LCD', url:'https://abestop.com/products/abestop-at6301', price:'$129' },
    { name:'Arduino Uno R4', cat:'MCU', desc:'Renesas RA4M1 + ESP32-S3, USB-C, 48MHz ARM Cortex-M4', url:'https://store.arduino.cc/products/uno-r4-wifi', price:'$27.50' },
    { name:'Arduino Nano ESP32', cat:'MCU', desc:'ESP32-S3, WiFi/BLE, USB-C, Arduino Cloud ready', url:'https://store.arduino.cc/products/nano-esp32', price:'$20' },
    { name:'ESP32-S3 DevKit', cat:'MCU', desc:'Dual-core 240MHz, WiFi/BLE, USB OTG, 512KB SRAM', url:'https://www.adafruit.com/product/5364', price:'$10' },
    { name:'Raspberry Pi 5', cat:'SBC', desc:'Broadcom BCM2712, 2.4GHz quad-core, 4/8GB RAM', url:'https://www.adafruit.com/product/5812', price:'$60' },
    { name:'Raspberry Pi Pico 2', cat:'MCU', desc:'RP2350, dual ARM Cortex-M33 / RISC-V, 520KB SRAM', url:'https://www.adafruit.com/product/6008', price:'$5' },
    { name:'Adafruit INA219 Breakout', cat:'Sensor', desc:'High-side DC current/voltage sensor, I2C, 26V/3.2A max', url:'https://www.adafruit.com/product/904', price:'$9.95' },
    { name:'ADS1115 16-bit ADC', cat:'ADC', desc:'4-channel 16-bit ADC, I2C, programmable gain amp', url:'https://www.adafruit.com/product/1085', price:'$14.95' },
    { name:'SparkFun Qwiic Multimeter', cat:'Meter', desc:'Digital multimeter with Qwiic/I2C interface, auto-ranging', url:'https://www.sparkfun.com/products/retired/18290', price:'$39.95' },
    { name:'DPS5005 Buck Module', cat:'PSU', desc:'50V/5A programmable step-down, color LCD, USB comm', url:'https://www.digikey.com', price:'$30' },
    { name:'MOSFET IRF520 Module', cat:'Switch', desc:'N-channel MOSFET driver module, 0-24V, PWM capable', url:'https://www.sparkfun.com', price:'$2' },
    { name:'Relay Module 4-ch', cat:'Switch', desc:'4-channel 5V relay module, optocoupler isolation', url:'https://www.adafruit.com', price:'$7.95' },
    { name:'Logic Level Converter', cat:'Interface', desc:'Bi-directional 3.3Vâ†”5V, 4 channels, I2C/SPI safe', url:'https://www.sparkfun.com/products/12009', price:'$3.50' },
    { name:'USB-UART CP2102', cat:'Interface', desc:'USB to UART bridge, 3.3V/5V, auto-reset for Arduino', url:'https://www.sparkfun.com', price:'$5' },
    { name:'Banana to Alligator Leads', cat:'Cable', desc:'Test lead set, banana plug to alligator clip, 4 colors', url:'https://www.adafruit.com/product/3290', price:'$4.95' },
    { name:'Breadboard 830-point', cat:'Proto', desc:'Full-size solderless breadboard, 830 tie points', url:'https://www.adafruit.com/product/239', price:'$5.95' },
];

function renderParts(filter) {
    const f = (filter || '').toLowerCase();
    const list = parts.filter(p => !f || p.name.toLowerCase().includes(f) || p.cat.toLowerCase().includes(f) || p.desc.toLowerCase().includes(f));
    $('parts-list').innerHTML = list.map(p => `
        <div class="supplier-card" onclick="window.open('${p.url}','_blank')">
            <div class="s-name"><span style="background:var(--bg3);padding:1px 6px;border-radius:3px;font-size:.5rem;color:var(--accent)">${p.cat}</span> ${p.name} <span style="color:var(--green);font-size:.625rem;margin-left:auto">${p.price}</span></div>
            <div class="s-desc">${p.desc}</div>
            <div class="s-url">${p.url}</div>
        </div>`).join('') || '<div style="color:var(--text-m);text-align:center;padding:20px">No parts matching filter</div>';
}

$('parts-search').addEventListener('input', e => renderParts(e.target.value));
renderParts();

// ===== SUPPLIERS =====
const suppliers = [
    { name:'Adafruit', icon:'ðŸŒ¿', url:'https://www.adafruit.com', desc:'Open-source electronics, breakout boards, sensors, Feather/QT Py ecosystem. Excellent tutorials and learning guides.', search:'https://www.adafruit.com/?q=' },
    { name:'SparkFun', icon:'ðŸ”´', url:'https://www.sparkfun.com', desc:'Qwiic ecosystem, breakout boards, development kits, tutorials. Great for prototyping and IoT.', search:'https://www.sparkfun.com/search#q=' },
    { name:'DigiKey', icon:'ðŸ”‘', url:'https://www.digikey.com', desc:'Massive component catalog (13M+ parts), datasheets, reference designs, parametric search. Professional supply chain.', search:'https://www.digikey.com/en/products/result?keywords=' },
    { name:'Mouser', icon:'ðŸ­', url:'https://www.mouser.com', desc:'1.1M+ parts in stock, new product introductions, technical resources. Professional component distribution.', search:'https://www.mouser.com/Search/Refine?Keyword=' },
    { name:'Arduino Store', icon:'ðŸŸ¢', url:'https://store.arduino.cc', desc:'Official Arduino boards, shields, kits. Arduino Cloud subscriptions and IoT plans.', search:'https://store.arduino.cc/search?q=' },
    { name:'JLCPCB', icon:'ðŸ­', url:'https://jlcpcb.com', desc:'PCB manufacturing from $2, SMT assembly, 3D printing. Fast turnaround for prototypes.', search:'https://jlcpcb.com/partdetail/' },
    { name:'LCSC', icon:'ðŸ”§', url:'https://www.lcsc.com', desc:'Component supplier paired with JLCPCB. Large inventory of passives, ICs, connectors.', search:'https://www.lcsc.com/search?q=' },
    { name:'Abestop', icon:'âš¡', url:'https://abestop.com', desc:'Bench power supplies (AT series), lab equipment. Affordable DC PSUs with SCPI support.', search:'https://abestop.com/search?q=' },
    { name:'Seeed Studio', icon:'ðŸŒ±', url:'https://www.seeedstudio.com', desc:'XIAO MCUs, Grove ecosystem, industrial IoT, reComputer. Fusion PCB service.', search:'https://www.seeedstudio.com/catalogsearch/result/?q=' },
    { name:'Pimoroni', icon:'ðŸ´â€â˜ ï¸', url:'https://shop.pimoroni.com', desc:'Raspberry Pi accessories, Pico add-ons, Enviro boards. UK-based with global shipping.', search:'https://shop.pimoroni.com/search?q=' },
];

function renderSuppliers(filter) {
    const f = (filter || '').toLowerCase();
    const list = suppliers.filter(s => !f || s.name.toLowerCase().includes(f) || s.desc.toLowerCase().includes(f));
    $('supplier-list').innerHTML = list.map(s => `
        <div class="supplier-card">
            <div class="s-name">${s.icon} ${s.name} <a href="${s.url}" target="_blank" style="margin-left:auto;font-size:.5625rem">Visit â†—</a></div>
            <div class="s-desc">${s.desc}</div>
            <div style="margin-top:6px;display:flex;gap:4px">
                <input class="supplier-search" style="margin:0;flex:1;font-size:.625rem;padding:4px 8px" placeholder="Search ${s.name}..." data-search-url="${s.search}" onkeydown="if(event.key==='Enter')window.open(this.dataset.searchUrl+encodeURIComponent(this.value),'_blank')">
                <button onclick="this.previousElementSibling.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter'}))" style="padding:4px 8px;font-size:.5625rem;border:1px solid var(--border);border-radius:4px;background:var(--bg3);color:var(--accent);cursor:pointer">Go</button>
            </div>
        </div>`).join('');
}

$('supplier-search').addEventListener('input', e => renderSuppliers(e.target.value));
renderSuppliers();

// ===== ARDUINO CODE EDITOR =====
const DEFAULT_CODE = `// hexbench â€” Arduino Sketch
// Power Supply Monitor with AT6301 + INA219
// Stream data to hexterm via Serial/WebSocket

#include <Wire.h>
#include <Adafruit_INA219.h>

Adafruit_INA219 ina219;

// AT6301 SCPI commands (via USB serial)
// Example: "MEAS:VOLT?", "MEAS:CURR?", "OUTP ON"

float voltage_V = 0;
float current_mA = 0;
float power_mW = 0;

void setup() {
    Serial.begin(115200);
    while (!Serial) delay(10);

    Serial.println("hexbench â€” PSU Monitor v1.0");
    Serial.println("Initializing INA219...");

    if (!ina219.begin()) {
        Serial.println("ERROR: INA219 not found!");
        while (1) delay(10);
    }
    Serial.println("INA219 ready");
    Serial.println("---");
}

void loop() {
    voltage_V = ina219.getBusVoltage_V();
    current_mA = ina219.getCurrent_mA();
    power_mW = ina219.getPower_mW();

    // JSON output for hexterm stream parsing
    Serial.print("{");
    Serial.print("\\"v\\":");  Serial.print(voltage_V, 3);
    Serial.print(",\\"i\\":"); Serial.print(current_mA, 2);
    Serial.print(",\\"p\\":"); Serial.print(power_mW, 2);
    Serial.print(",\\"t\\":"); Serial.print(millis());
    Serial.println("}");

    delay(500);
}
`;

const codeTemplates = {
    'PSU Monitor': DEFAULT_CODE,
    'Blink LED': `// hexbench â€” Blink
void setup() { pinMode(LED_BUILTIN, OUTPUT); }
void loop() { digitalWrite(LED_BUILTIN, HIGH); delay(1000); digitalWrite(LED_BUILTIN, LOW); delay(1000); }`,
    'Serial Logger': `// hexbench â€” Serial Data Logger
void setup() {
    Serial.begin(115200);
    Serial.println("hexbench logger ready");
}
void loop() {
    int adc = analogRead(A0);
    float voltage = adc * (5.0 / 1023.0);
    Serial.print("{"v":"); Serial.print(voltage, 3);
    Serial.print(",\\"raw\\":"); Serial.print(adc);
    Serial.println("}");
    delay(100);
}`,
    'ESP32 WiFi Stream': `// hexbench â€” ESP32 WiFi â†’ hexterm WebSocket
#include <WiFi.h>
#include <WebSocketsClient.h>

const char* ssid = "YOUR_SSID";
const char* password = "YOUR_PASS";
const char* wsHost = "192.168.0.44";
const int wsPort = 9877;

WebSocketsClient ws;

void setup() {
    Serial.begin(115200);
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) { delay(500); Serial.print("."); }
    Serial.println("\\nWiFi connected: " + WiFi.localIP().toString());
    ws.begin(wsHost, wsPort, "/");
}

void loop() {
    ws.loop();
    float v = analogRead(A0) * (3.3 / 4095.0);
    String json = "{"v":" + String(v, 3) + ",\\"t\\":" + String(millis()) + "}";
    ws.sendTXT(json);
    delay(200);
}`,
    'SCPI AT6301': `// hexbench â€” SCPI control for Abestop AT6301
// Connect AT6301 USB to computer, use serial bridge
// SCPI commands reference:
//   *IDN?          â€” Device identification
//   MEAS:VOLT?     â€” Measure actual voltage
//   MEAS:CURR?     â€” Measure actual current
//   VOLT <value>   â€” Set voltage (e.g. VOLT 5.00)
//   CURR <value>   â€” Set current limit
//   OUTP ON|OFF    â€” Enable/disable output
//   *SAV <1-4>     â€” Save to memory slot
//   *RCL <1-4>     â€” Recall memory slot

void setup() {
    Serial.begin(9600);   // AT6301 USB baud
    Serial1.begin(115200); // Debug output

    Serial1.println("AT6301 SCPI Controller");

    // Query device
    Serial.println("*IDN?");
    delay(200);
    while (Serial.available()) Serial1.write(Serial.read());

    // Set 5V / 1A
    Serial.println("VOLT 5.00");
    Serial.println("CURR 1.000");
    Serial.println("OUTP ON");
    Serial1.println("Output: 5V / 1A ON");
}

void loop() {
    Serial.println("MEAS:VOLT?");
    delay(100);
    String v = "";
    while (Serial.available()) v += (char)Serial.read();

    Serial.println("MEAS:CURR?");
    delay(100);
    String i = "";
    while (Serial.available()) i += (char)Serial.read();

    Serial1.println("V=" + v.trim() + " A=" + i.trim());
    delay(1000);
}`,
};

const codeEditor = $('code-editor');
const codeOutput = $('code-output');
codeEditor.value = DEFAULT_CODE;

$('code-verify').addEventListener('click', () => {
    codeOutput.innerHTML = '';
    codeLog('info', 'Verifying sketch...');
    // Basic syntax checks
    const code = codeEditor.value;
    const hasSetup = code.includes('void setup()');
    const hasLoop = code.includes('void loop()');
    const errors = [];
    if (!hasSetup) errors.push('Missing void setup()');
    if (!hasLoop) errors.push('Missing void loop()');
    // Check brace matching
    let braces = 0;
    for (const ch of code) { if (ch === '{') braces++; if (ch === '}') braces--; }
    if (braces !== 0) errors.push(`Mismatched braces (${braces > 0 ? braces + ' unclosed' : Math.abs(braces) + ' extra'})`);

    if (errors.length) {
        errors.forEach(e => codeLog('error', e));
    } else {
        const lines = code.split('\n').length;
        codeLog('success', `Sketch OK â€” ${lines} lines, ${code.length} bytes`);
        if (code.includes('#include')) {
            const libs = [...code.matchAll(/#include\s*[<"](.+?)[>"]/g)].map(m => m[1]);
            codeLog('info', `Libraries: ${libs.join(', ')}`);
        }
    }
});

$('code-upload').addEventListener('click', () => {
    codeLog('info', 'Upload requires Arduino CLI or Arduino Cloud connection');
    codeLog('info', 'Install: brew install arduino-cli');
    codeLog('info', 'Or use: Arduino Cloud Editor â†’ https://create.arduino.cc/editor');
    codeLog('info', 'Or use: Codebender â†’ https://codebender.cc');
});

$('code-stream').addEventListener('click', () => {
    codeLog('info', 'Streaming sketch to hexterm...');
    // Send via BroadcastChannel if available
    try {
        const bc = new BroadcastChannel('hexterm');
        bc.postMessage({ type: 'code', language: 'arduino', content: codeEditor.value, from: 'hexbench' });
        codeLog('success', 'Sent to hexterm via BroadcastChannel');
        bc.close();
    } catch (e) {
        codeLog('error', 'hexterm not connected â€” open terminal.html first');
    }
});

$('code-template').addEventListener('click', () => {
    const names = Object.keys(codeTemplates);
    const choice = prompt('Templates:\\n' + names.map((n, i) => `${i + 1}. ${n}`).join('\\n') + '\\n\\nEnter number:');
    const idx = parseInt(choice) - 1;
    if (idx >= 0 && idx < names.length) {
        codeEditor.value = codeTemplates[names[idx]];
        codeLog('info', `Loaded template: ${names[idx]}`);
    }
});

function codeLog(level, msg) {
    const colors = { info: 'var(--accent)', error: 'var(--red)', success: 'var(--green)', warn: 'var(--orange)' };
    codeOutput.innerHTML += `<div style="color:${colors[level] || 'var(--text-m)'}"><span style="color:var(--text-m);font-size:.5625rem">${new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'})}</span> ${msg}</div>`;
    codeOutput.scrollTop = codeOutput.scrollHeight;
}

// ===== PANEL RESIZE =====
const panelResize = $('panel-resize');
let panelDragging = false;
panelResize.addEventListener('mousedown', () => { panelDragging = true; panelResize.classList.add('active'); });
document.addEventListener('mousemove', e => {
    if (!panelDragging) return;
    const main = document.querySelector('.main');
    const pct = (e.clientX / main.offsetWidth) * 100;
    $('doc-panel').style.width = Math.max(20, Math.min(70, pct)) + '%';
});
document.addEventListener('mouseup', () => { panelDragging = false; panelResize.classList.remove('active'); });

const consoleResize = $('console-resize');
let consoleDragging = false;
consoleResize.addEventListener('mousedown', () => { consoleDragging = true; consoleResize.classList.add('active'); });
document.addEventListener('mousemove', e => {
    if (!consoleDragging) return;
    const appH = document.querySelector('.app').offsetHeight;
    const h = appH - e.clientY;
    $('console-panel').style.height = Math.max(60, Math.min(400, h)) + 'px';
});
document.addEventListener('mouseup', () => { consoleDragging = false; consoleResize.classList.remove('active'); });

// ===== NODE ENGINE =====
const nodesData = [];
const connections = [];
let nodeIdCounter = 0;
const inner = $('canvas-inner');
const svgEl = $('connections-svg');

const nodeTypes = {
    psu:         { icon:'âš¡', color:'#ffe138', label:'Power Supply', action:true },
    multimeter:  { icon:'ðŸ“Š', color:'#3fb950', label:'Multimeter',   action:true },
    oscilloscope:{ icon:'ðŸ“ˆ', color:'#58a6ff', label:'Oscilloscope', action:true },
    arduino:     { icon:'ðŸŸ¢', color:'#00979D', label:'Arduino',      action:true },
    esp32:       { icon:'ðŸ“¡', color:'#f0883e', label:'ESP32',        action:true },
    raspberry:   { icon:'ðŸ“', color:'#c51a4a', label:'Raspberry Pi', action:true },
    sensor:      { icon:'ðŸŒ¡', color:'#56d4dd', label:'Sensor' },
    led:         { icon:'ðŸ’¡', color:'#ffe138', label:'LED' },
    motor:       { icon:'âš™', color:'#8b949e', label:'Motor' },
    relay:       { icon:'ðŸ”Œ', color:'#f0883e', label:'Relay' },
    measure:     { icon:'ðŸ“', color:'#a78bfa', label:'Measure',  action:true },
    calculate:   { icon:'ðŸ§®', color:'#56d4dd', label:'Calculate', action:true },
    stream:      { icon:'ðŸ“¡', color:'#f85149', label:'Stream',    action:true },
    resistor:    { icon:'Î©',  color:'#8b949e', label:'Resistor' },
    capacitor:   { icon:'â¸', color:'#58a6ff', label:'Capacitor' },
    usb:         { icon:'ðŸ”Œ', color:'#e6edf3', label:'USB' },
    wire:        { icon:'ã€°', color:'#3fb950', label:'Wire' },
};

function createNode(type, x, y, name, ports) {
    const id = nodeIdCounter++;
    const t = nodeTypes[type] || { icon:'ðŸ”§', color:'#8b949e', label:'Component' };
    const n = { id, type, x, y, name: name || t.label, ports: ports || ['in','out'], status:'idle' };
    nodesData.push(n);
    const el = document.createElement('div');
    el.className = 'node' + (t.action ? ' action-node' : '');
    el.id = 'node-' + id;
    el.style.left = x + 'px'; el.style.top = y + 'px';
    el.innerHTML = `
        <div class="node-hdr">
            <div class="node-icon" style="background:${t.color}22;border:1px solid ${t.color}">${t.icon}</div>
            <div><div class="node-name">${n.name}</div><div class="node-sub">${type}</div></div>
        </div>
        <div class="node-body"><div class="node-ports">
            ${n.ports.map(p => `<div class="node-port"><span class="port-dot${p==='out'?' out':''} connected" data-node="${id}" data-port="${p}"></span>${p}</div>`).join('')}
        </div></div>
        ${t.action ? `<div class="node-action-bar"><button class="node-run-btn" data-node-id="${id}">â–¶ Run</button></div>` : ''}`;
    inner.appendChild(el);
    makeDraggable(el, n);
    updateStats();
    return n;
}

function makeDraggable(el, nd) {
    let dragging = false, ox, oy;
    el.addEventListener('mousedown', e => {
        if (e.target.classList.contains('port-dot') || e.target.classList.contains('node-run-btn')) return;
        dragging = true;
        const r = el.getBoundingClientRect();
        ox = e.clientX - r.left; oy = e.clientY - r.top;
        el.style.zIndex = '10';
        document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
        el.classList.add('selected');
    });
    document.addEventListener('mousemove', e => {
        if (!dragging) return;
        const s = $('canvas-scroll'), sr = s.getBoundingClientRect();
        nd.x = Math.max(0, e.clientX - sr.left + s.scrollLeft - ox);
        nd.y = Math.max(0, e.clientY - sr.top + s.scrollTop - oy);
        el.style.left = nd.x + 'px'; el.style.top = nd.y + 'px';
        drawConnections();
    });
    document.addEventListener('mouseup', () => { if (dragging) { dragging = false; el.style.zIndex = ''; } });
    el.addEventListener('touchstart', e => {
        if (e.target.classList.contains('port-dot') || e.target.classList.contains('node-run-btn')) return;
        dragging = true;
        const r = el.getBoundingClientRect();
        ox = e.touches[0].clientX - r.left; oy = e.touches[0].clientY - r.top;
    }, { passive: true });
    el.addEventListener('touchmove', e => {
        if (!dragging) return;
        const s = $('canvas-scroll'), sr = s.getBoundingClientRect();
        nd.x = Math.max(0, e.touches[0].clientX - sr.left + s.scrollLeft - ox);
        nd.y = Math.max(0, e.touches[0].clientY - sr.top + s.scrollTop - oy);
        el.style.left = nd.x + 'px'; el.style.top = nd.y + 'px';
        drawConnections();
        e.preventDefault();
    }, { passive: false });
    el.addEventListener('touchend', () => { dragging = false; }, { passive: true });
}

function addConnection(fromId, toId) {
    connections.push({ from: fromId, to: toId });
    drawConnections(); updateStats();
}

function drawConnections() {
    let svg = '';
    connections.forEach(c => {
        const fe = document.getElementById('node-' + c.from);
        const te = document.getElementById('node-' + c.to);
        if (!fe || !te) return;
        const fn = nodesData.find(n => n.id === c.from), tn = nodesData.find(n => n.id === c.to);
        if (!fn || !tn) return;
        const x1 = fn.x + fe.offsetWidth, y1 = fn.y + fe.offsetHeight / 2;
        const x2 = tn.x, y2 = tn.y + te.offsetHeight / 2;
        const dx = Math.abs(x2 - x1) * .5;
        svg += `<path class="conn-path active" d="M${x1},${y1} C${x1+dx},${y1} ${x2-dx},${y2} ${x2},${y2}"/>`;
    });
    svgEl.innerHTML = svg;
}

// â”€â”€ Zoom / Pan â”€â”€
let canvasZoom = 1, panX = 0, panY = 0, isPanning = false, panStartX, panStartY;
const scrollEl = $('canvas-scroll'), gridEl = $('canvas-grid');

function applyTransform() {
    inner.style.transform = `translate(${panX}px,${panY}px) scale(${canvasZoom})`;
    if (gridEl) gridEl.style.backgroundSize = `${24*canvasZoom}px ${24*canvasZoom}px`;
    $('zoom-label').textContent = Math.round(canvasZoom * 100) + '%';
    drawConnections();
}

function setZoom(z, cx, cy) {
    const oldZ = canvasZoom;
    canvasZoom = Math.min(3, Math.max(0.2, z));
    if (cx !== undefined) {
        panX = cx - (cx - panX) * (canvasZoom / oldZ);
        panY = cy - (cy - panY) * (canvasZoom / oldZ);
    }
    applyTransform();
}

scrollEl.addEventListener('wheel', e => {
    e.preventDefault();
    const rect = scrollEl.getBoundingClientRect();
    setZoom(canvasZoom * (e.deltaY > 0 ? 0.9 : 1.1), e.clientX - rect.left, e.clientY - rect.top);
}, { passive: false });

scrollEl.addEventListener('mousedown', e => {
    if (e.target.closest('.node') || e.target.closest('.zoom-controls')) return;
    isPanning = true;
    panStartX = e.clientX - panX; panStartY = e.clientY - panY;
    scrollEl.style.cursor = 'grabbing';
});
document.addEventListener('mousemove', e => { if (!isPanning) return; panX = e.clientX - panStartX; panY = e.clientY - panStartY; applyTransform(); });
document.addEventListener('mouseup', () => { if (isPanning) { isPanning = false; scrollEl.style.cursor = 'grab'; } });

let lastTouchDist = 0;
scrollEl.addEventListener('touchstart', e => {
    if (e.target.closest('.node')) return;
    if (e.touches.length === 1) { isPanning = true; panStartX = e.touches[0].clientX - panX; panStartY = e.touches[0].clientY - panY; }
    if (e.touches.length === 2) { lastTouchDist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY); }
}, { passive: true });
scrollEl.addEventListener('touchmove', e => {
    if (e.target.closest('.node')) return;
    if (e.touches.length === 1 && isPanning) { panX = e.touches[0].clientX - panStartX; panY = e.touches[0].clientY - panStartY; applyTransform(); e.preventDefault(); }
    if (e.touches.length === 2) {
        const d = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
        if (lastTouchDist) { const rect = scrollEl.getBoundingClientRect(); setZoom(canvasZoom * (d / lastTouchDist), (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left, (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top); }
        lastTouchDist = d; e.preventDefault();
    }
}, { passive: false });
scrollEl.addEventListener('touchend', () => { isPanning = false; lastTouchDist = 0; }, { passive: true });

$('zoom-in')?.addEventListener('click', () => setZoom(canvasZoom * 1.2));
$('zoom-out')?.addEventListener('click', () => setZoom(canvasZoom / 1.2));
$('zoom-reset')?.addEventListener('click', () => { canvasZoom = 1; panX = 0; panY = 0; applyTransform(); });
$('zoom-fit')?.addEventListener('click', () => {
    if (!nodesData.length) return;
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    nodesData.forEach(n => { minX = Math.min(minX, n.x); minY = Math.min(minY, n.y); maxX = Math.max(maxX, n.x + 200); maxY = Math.max(maxY, n.y + 120); });
    const rect = scrollEl.getBoundingClientRect();
    canvasZoom = Math.min(2, Math.max(0.2, Math.min(rect.width / (maxX - minX + 80), rect.height / (maxY - minY + 80))));
    panX = (rect.width - (maxX - minX) * canvasZoom) / 2 - minX * canvasZoom;
    panY = (rect.height - (maxY - minY) * canvasZoom) / 2 - minY * canvasZoom;
    applyTransform();
});

function updateStats() {
    $('ftr-nodes').textContent = nodesData.length + ' nodes';
    $('ftr-conns').textContent = connections.length + ' connections';
}

function clearCanvas() {
    nodesData.length = 0; connections.length = 0; nodeIdCounter = 0;
    inner.querySelectorAll('.node').forEach(n => n.remove());
    svgEl.innerHTML = ''; updateStats();
}

// ===== ACTION NODE EXECUTION =====
async function executeNode(nodeId) {
    const nd = nodesData.find(n => n.id === nodeId);
    if (!nd) return;
    const el = document.getElementById('node-' + nodeId);
    el?.classList.add('running'); nd.status = 'running';
    logConsole(nd.type, `Running ${nd.name}...`);
    try {
        switch (nd.type) {
            case 'psu':
                logConsole('psu', `AT6301: ${psuVoltage.toFixed(2)}V / ${psuCurrent.toFixed(3)}A = ${(psuVoltage*psuCurrent).toFixed(2)}W`);
                logConsole('psu', `Output: ${psuOutput ? 'ON' : 'OFF'} | Mode: ${psuVoltage*psuCurrent > AT6301.maxW ? 'OVER POWER!' : 'OK'}`);
                break;
            case 'multimeter':
                logConsole('meter', `V: ${(psuVoltage + (Math.random()-.5)*.01).toFixed(4)}V | I: ${(psuCurrent*1000 + (Math.random()-.5)*0.1).toFixed(2)}mA`);
                logConsole('meter', `R: ${psuCurrent > 0 ? (psuVoltage/psuCurrent).toFixed(2) : 'âˆž'} Î© | Freq: 60.00 Hz`);
                break;
            case 'oscilloscope':
                logConsole('scope', 'Waveform: DC steady state');
                logConsole('scope', `Vpp: ${(Math.random()*0.02).toFixed(4)}V ripple | Freq: ${psuOutput ? '60Hz mains' : 'no signal'}`);
                break;
            case 'arduino':
                logConsole('arduino', 'Board: Arduino Uno R4 WiFi | Port: /dev/cu.usbmodem*');
                logConsole('arduino', 'Upload sketch from Code tab, or use: arduino-cli upload -b arduino:renesas_uno:unor4wifi');
                break;
            case 'esp32':
                logConsole('esp32', 'Board: ESP32-S3 | WiFi: scanning...');
                logConsole('esp32', 'Flash: esptool.py or Arduino IDE | Stream: WebSocket on port 9877');
                break;
            case 'raspberry':
                logConsole('rpi', 'Raspberry Pi 5 | SSH: ssh pi@raspberrypi.local');
                logConsole('rpi', 'GPIO: python3 -c "from gpiozero import LED; LED(17).on()"');
                break;
            case 'measure':
                logConsole('measure', `Voltage: ${psuVoltage.toFixed(4)}V | Current: ${(psuCurrent*1000).toFixed(2)}mA | Power: ${(psuVoltage*psuCurrent).toFixed(4)}W`);
                break;
            case 'calculate':
                logConsole('calc', `V=${psuVoltage}V I=${psuCurrent}A â†’ P=${(psuVoltage*psuCurrent).toFixed(3)}W R=${psuCurrent>0?(psuVoltage/psuCurrent).toFixed(3):'âˆž'}Î©`);
                break;
            case 'stream':
                logConsole('stream', 'Streaming to hexterm via BroadcastChannel...');
                try {
                    const bc = new BroadcastChannel('hexterm');
                    bc.postMessage({ type: 'bench-data', v: psuVoltage, a: psuCurrent, w: psuVoltage * psuCurrent, t: Date.now(), from: 'hexbench' });
                    logConsole('stream', 'Data sent to hexterm');
                    bc.close();
                } catch(e) { logConsole('error', 'hexterm not connected'); }
                break;
            default:
                logConsole(nd.type, `${nd.name} â€” component node (passive)`);
        }
        nd.status = 'done'; el?.classList.remove('running'); el?.classList.add('done');
        setTimeout(() => el?.classList.remove('done'), 3000);
    } catch (e) {
        nd.status = 'error'; el?.classList.remove('running'); el?.classList.add('error');
        logConsole('error', e.message);
        setTimeout(() => el?.classList.remove('error'), 3000);
    }
}

document.addEventListener('click', e => {
    if (e.target.classList.contains('node-run-btn')) executeNode(parseInt(e.target.dataset.nodeId));
});

// ===== PRESETS =====
function loadAT6301Setup() {
    clearCanvas();
    const psu   = createNode('psu',         60,  60,  'AT6301 PSU',    ['V+','V-','USB','out']);
    const meter = createNode('multimeter',  340, 60,  'Multimeter',    ['in','probe+','probe-']);
    const ina   = createNode('sensor',      340, 240, 'INA219 Sensor', ['SDA','SCL','V+','V-']);
    const uno   = createNode('arduino',     620, 60,  'Arduino Uno R4',['A0','SDA','SCL','5V','GND','USB']);
    const load  = createNode('resistor',    60,  240, 'Test Load',     ['in','out']);
    const usb   = createNode('usb',         620, 240, 'USB to PC',     ['in']);
    const strm  = createNode('stream',      880, 60,  'hexterm Stream',['in']);

    addConnection(psu.id, meter.id);
    addConnection(psu.id, load.id);
    addConnection(meter.id, ina.id);
    addConnection(ina.id, uno.id);
    addConnection(uno.id, usb.id);
    addConnection(uno.id, strm.id);
    setTimeout(drawConnections, 50);
    logConsole('sys', 'Loaded: AT6301 PSU â†’ INA219 â†’ Arduino â†’ hexterm pipeline');
}

function loadArduinoLab() {
    clearCanvas();
    const uno   = createNode('arduino',    60,  60,  'Arduino Uno R4', ['5V','3.3V','GND','A0','D2','D3','SDA','SCL','USB']);
    const led1  = createNode('led',        340, 60,  'LED (D2)',       ['in']);
    const led2  = createNode('led',        340, 180, 'LED (D3)',       ['in']);
    const temp  = createNode('sensor',     340, 300, 'Temp Sensor',    ['VCC','GND','out']);
    const pot   = createNode('resistor',   60,  300, 'Potentiometer',  ['out']);
    const esp   = createNode('esp32',      620, 60,  'ESP32-S3',      ['WiFi','BLE','SPI','I2C','USB']);
    const rpi   = createNode('raspberry',  620, 240, 'RPi 5',         ['GPIO','I2C','SPI','USB','ETH']);
    const strm  = createNode('stream',     880, 150, 'hexterm Stream', ['in']);

    addConnection(uno.id, led1.id);
    addConnection(uno.id, led2.id);
    addConnection(temp.id, uno.id);
    addConnection(pot.id, uno.id);
    addConnection(uno.id, esp.id);
    addConnection(esp.id, strm.id);
    addConnection(rpi.id, strm.id);
    setTimeout(drawConnections, 50);
    logConsole('sys', 'Loaded: Arduino Lab â€” MCU + sensors + streaming');
}

$('preset-at6301').addEventListener('click', loadAT6301Setup);
$('preset-arduino').addEventListener('click', loadArduinoLab);
$('preset-clear').addEventListener('click', clearCanvas);

document.querySelectorAll('.pal-chip[data-type]').forEach(chip => {
    chip.addEventListener('click', () => {
        createNode(chip.dataset.type, 100 + Math.random() * 300, 80 + Math.random() * 200);
    });
});

// ===== CONSOLE =====
function logConsole(tag, msg) {
    const log = $('console-log');
    const ts = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const colors = { sys:'#58a6ff', error:'#f85149', psu:'#ffe138', meter:'#3fb950', scope:'#58a6ff',
                     arduino:'#00979D', esp32:'#f0883e', rpi:'#c51a4a', measure:'#a78bfa',
                     calc:'#56d4dd', stream:'#f85149', chat:'#e6edf3', info:'#58a6ff' };
    log.innerHTML += `<div class="log-line"><span class="log-ts">${ts}</span><span class="log-tag" style="color:${colors[tag]||'#8b949e'}">${tag}</span><span class="log-msg">${msg}</span></div>`;
    log.scrollTop = log.scrollHeight;
}

const consoleInput = $('console-input');
function handleConsoleInput() {
    const val = consoleInput.value.trim();
    if (!val) return;
    consoleInput.value = '';
    logConsole('chat', val);
    if (val.startsWith('/')) {
        const cmd = val.slice(1).split(' ')[0];
        const arg = val.slice(cmd.length + 2).trim();
        switch (cmd) {
            case 'clear': $('console-log').innerHTML = ''; break;
            case 'nodes': logConsole('sys', JSON.stringify(nodesData.map(n => n.name))); break;
            case 'volt': case 'v': psuVoltage = parseFloat(arg) || psuVoltage; renderBench(); logConsole('psu', `Voltage â†’ ${psuVoltage}V`); break;
            case 'curr': case 'i': psuCurrent = parseFloat(arg) || psuCurrent; renderBench(); logConsole('psu', `Current â†’ ${psuCurrent}A`); break;
            case 'on': psuOutput = true; renderBench(); logConsole('psu', 'OUTPUT ON'); break;
            case 'off': psuOutput = false; renderBench(); logConsole('psu', 'OUTPUT OFF'); break;
            case 'preset': loadAT6301Setup(); break;
            case 'arduino': loadArduinoLab(); break;
            case 'ohm': {
                const [v, i] = arg.split(/[,\s]+/).map(Number);
                if (v && i) logConsole('calc', `R = ${(v/i).toFixed(4)} Î©, P = ${(v*i).toFixed(4)} W`);
                break;
            }
            case 'run': {
                const nd = nodesData.find(n => n.name.toLowerCase().includes(arg.toLowerCase()));
                if (nd) executeNode(nd.id); else logConsole('error', 'Node not found: ' + arg);
                break;
            }
            case 'search': {
                const s = suppliers.find(s => s.name.toLowerCase().includes(arg.toLowerCase()));
                if (s) { window.open(s.search + encodeURIComponent(arg), '_blank'); logConsole('sys', `Searching ${s.name}...`); }
                else { window.open('https://www.digikey.com/en/products/result?keywords=' + encodeURIComponent(arg), '_blank'); logConsole('sys', 'Searching DigiKey...'); }
                break;
            }
            case 'help':
                logConsole('sys', 'Commands: /v <volts> /i <amps> /on /off /ohm <V,I> /nodes /run <node> /search <term> /preset /arduino /clear /help');
                break;
            default: logConsole('sys', 'Unknown: /' + cmd + ' â€” /help');
        }
    }
}

consoleInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleConsoleInput(); });
$('console-send').addEventListener('click', handleConsoleInput);

// ===== SAVE/EXPORT =====
$('doc-save').addEventListener('click', () => {
    localStorage.setItem('hexbench-psu-v', psuVoltage);
    localStorage.setItem('hexbench-psu-a', psuCurrent);
    localStorage.setItem('hexbench-code', codeEditor.value);
    logConsole('sys', 'Settings saved');
});

$('doc-export').addEventListener('click', () => {
    const data = { psu: { v: psuVoltage, a: psuCurrent, output: psuOutput }, code: codeEditor.value, nodes: nodesData, connections };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'hexbench-' + Date.now() + '.json'; a.click();
    logConsole('sys', 'Exported hexbench state');
});

// ===== INIT =====
// Restore saved state
const sv = localStorage.getItem('hexbench-psu-v');
const sa = localStorage.getItem('hexbench-psu-a');
const sc = localStorage.getItem('hexbench-code');
if (sv) psuVoltage = parseFloat(sv);
if (sa) psuCurrent = parseFloat(sa);
if (sc) codeEditor.value = sc;
renderBench();

loadAT6301Setup();
logConsole('sys', 'hexbench initialized â€” Voltage Lab');
logConsole('sys', `Device: ${AT6301.name} (${AT6301.maxV}V/${AT6301.maxA}A/${AT6301.maxW}W)`);
logConsole('sys', 'Left: Bench / Parts / Code / Suppliers | Right: Workbench canvas');
logConsole('sys', 'Type /help for commands');

window.hexbench = {
    get nodes() { return [...nodesData]; },
    get connections() { return [...connections]; },
    addNode: createNode, connect: addConnection, execute: executeNode,
    loadAT6301: loadAT6301Setup, loadArduino: loadArduinoLab, clear: clearCanvas,
    log: logConsole, setPSU: (v, a) => { psuVoltage = v; psuCurrent = a; renderBench(); },
};

console.log('âš¡ hexbench â€” Voltage Lab | Power Supply + Electronics Workbench');
console.log('API: window.hexbench');
})();
</script>
</body>
</html>
