<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0d1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>uvspeed — launcher</title>
<style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
        width: 100%; height: 100%;
        background: #0d1117; color: #e6edf3;
        font-family: -apple-system, 'SF Pro', system-ui, sans-serif;
        overflow: hidden;
        -webkit-touch-callout: none;
        -webkit-user-select: none; user-select: none;
        touch-action: manipulation;
    }
    #app {
        display: flex; flex-direction: column; width: 100%; height: 100%;
    }

    /* Title bar */
    #titlebar {
        display: flex; align-items: center;
        flex-shrink: 0; height: 38px;
        background: #0d1117; position: relative;
        -webkit-app-region: drag;
        overflow: hidden;
        border-bottom: 1px solid #21262d;
    }
    #titlebar-stars { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
    #titlebar .traffic-spacer { width: 78px; flex-shrink: 0; }
    #titlebar .title {
        z-index: 1; flex: 1; text-align: center;
        font-size: .6875rem; font-family: 'SF Mono', monospace;
        color: #8b949e;
        /* keep drag — title text is part of the drag region */
    }
    /* Extra drag bar below titlebar for easier grabbing */
    #drag-strip {
        -webkit-app-region: drag;
        height: 6px; flex-shrink: 0;
        background: transparent; cursor: default;
    }

    /* Rainbow */
    .rainbow { display: flex; flex-shrink: 0; height: 2px; width: 100%; }
    .rainbow span { flex: 1; }
    .rainbow .r1 { background: #ff3838; }
    .rainbow .r2 { background: #ff8c38; }
    .rainbow .r3 { background: #ffe138; }
    .rainbow .r4 { background: #3fb950; }
    .rainbow .r5 { background: #38a5ff; }
    .rainbow .r6 { background: #bc8cff; }

    /* Main content */
    #main {
        flex: 1; display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        padding: 16px 24px; gap: 12px;
        position: relative; overflow: hidden;
    }
    #main-stars { position: absolute; inset: 0; z-index: 0; pointer-events: none; }

    /* Logo */
    .logo {
        font-family: 'SF Mono', 'Menlo', monospace;
        font-size: 2.5rem; font-weight: 900; letter-spacing: -1px;
        color: #e6edf3; z-index: 1; margin-bottom: 4px;
    }
    .logo .prefix { color: #58a6ff; font-size: .875rem; vertical-align: super; }
    .subtitle {
        font-family: 'SF Mono', monospace; font-size: .6875rem;
        color: #484f58; z-index: 1; margin-bottom: 24px;
    }

    /* Mode cards */
    .modes {
        display: flex; gap: 14px; z-index: 1;
        flex-wrap: wrap; justify-content: center;
    }
    .mode-card {
        width: 160px; padding: 20px 16px; border-radius: 12px;
        background: #161b22; border: 1px solid #21262d;
        cursor: pointer; text-align: center;
        transition: all 0.2s ease;
        touch-action: manipulation;
        -webkit-tap-highlight-color: rgba(56,165,255,0.2);
        -webkit-app-region: no-drag;
    }
    .mode-card:hover {
        border-color: #388bfd40; background: #1c2128;
        transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    .mode-card:active { transform: scale(0.97); }
    .mode-card .icon {
        font-size: 2rem; margin-bottom: 10px; display: block;
    }
    .mode-card .name {
        font-family: 'SF Mono', monospace; font-size: .875rem;
        font-weight: 600; color: #e6edf3; margin-bottom: 6px;
    }
    .mode-card .desc {
        font-size: .625rem; color: #8b949e;
        font-family: 'SF Mono', monospace; line-height: 1.4;
    }
    .mode-card.instance { border-color: #3fb95030; }
    .mode-card.instance:hover { border-color: #3fb950; }
    .mode-card.instance .icon { color: #3fb950; }
    .mode-card.gridview { border-color: #58a6ff30; }
    .mode-card.gridview:hover { border-color: #58a6ff; }
    .mode-card.gridview .icon { color: #58a6ff; }
    .mode-card.web { border-color: #bc8cff30; }
    .mode-card.web:hover { border-color: #bc8cff; }
    .mode-card.web .icon { color: #bc8cff; }

    /* Dev launch button */
    .dev-section {
        z-index: 1; margin-top: 10px; text-align: center;
    }
    .dev-btn {
        display: inline-flex; align-items: center; gap: 6px;
        background: none; border: 1px solid #30363d; color: #8b949e;
        padding: 6px 16px; border-radius: 6px; cursor: pointer;
        font-family: 'SF Mono', monospace; font-size: .625rem;
        transition: all 0.15s ease;
        touch-action: manipulation;
        -webkit-app-region: no-drag;
    }
    .dev-btn:hover { color: #e6edf3; border-color: #484f58; background: #161b22; }
    .dev-btn:active { transform: scale(0.97); }
    .dev-btn .brace { color: #58a6ff; }

    /* Mini console */
    #console-panel {
        flex-shrink: 0; display: flex; flex-direction: column;
        background: #0d1117; border-top: 1px solid #21262d;
        max-height: 160px; overflow: hidden;
        -webkit-app-region: no-drag;
    }
    #console-header {
        display: flex; align-items: center; padding: 3px 10px;
        font-size: .5625rem; font-family: 'SF Mono', monospace; color: #484f58;
        border-bottom: 1px solid #161b22; gap: 6px; cursor: pointer;
    }
    #console-header:hover { background: #161b22; }
    #console-header .arrow { transition: transform 0.2s; }
    #console-header.collapsed .arrow { transform: rotate(-90deg); }
    #console-log {
        flex: 1; overflow-y: auto; padding: 4px 10px;
        font-size: .5625rem; font-family: 'SF Mono', monospace;
        color: #8b949e; line-height: 1.5; max-height: 90px;
    }
    #console-log .ts { color: #484f58; }
    #console-log .ok { color: #3fb950; }
    #console-log .err { color: #da3633; }
    #console-log .cmd { color: #58a6ff; }
    #console-cmd {
        display: flex; border-top: 1px solid #161b22;
    }
    #console-cmd .prompt {
        color: #58a6ff; padding: 4px 6px;
        font-size: .5625rem; font-family: 'SF Mono', monospace;
        background: #0d1117;
    }
    #console-cmd input {
        flex: 1; background: #0d1117; border: none; color: #e6edf3;
        padding: 4px 6px; font-size: .5625rem; font-family: 'SF Mono', monospace;
        outline: none;
    }
    #console-cmd input::placeholder { color: #30363d; }

    /* Stats footer */
    #footer {
        flex-shrink: 0; display: flex; align-items: center;
        padding: 4px 12px; gap: 8px; min-height: 20px;
        background: #0d1117; border-top: 1px solid #21262d;
        font-size: .5rem; font-family: 'SF Mono', monospace; color: #484f58;
    }
    #footer .val { color: #3fb950; }
    #footer .spacer { flex: 1; }
    #footer .version { color: #484f58; }
</style>
</head>
<body>
<div id="app">
    <div id="titlebar">
        <canvas id="titlebar-stars"></canvas>
        <div class="traffic-spacer"></div>
        <div class="title">uvspeed launcher</div>
        <div style="width:78px;flex-shrink:0"></div>
    </div>
    <div class="rainbow"><span class="r1"></span><span class="r2"></span><span class="r3"></span><span class="r4"></span><span class="r5"></span><span class="r6"></span></div>
    <div id="drag-strip"></div>

    <div id="main">
        <canvas id="main-stars"></canvas>

        <div class="logo">uvspeed <span class="prefix">+1:</span></div>
        <div class="subtitle">{+1, 1, -1, +0, 0, -0, +n, n, -n}</div>

        <div class="modes">
            <div class="mode-card instance" onclick="launchMode('instance')" title="Full terminal with hexcast feeds">
                <span class="icon">⬡</span>
                <div class="name">instance</div>
                <div class="desc">full terminal + feed windows<br>one stream per window</div>
            </div>
            <div class="mode-card gridview" onclick="launchMode('grid')" title="Single canvas multi-stream grid">
                <span class="icon">⊞</span>
                <div class="name">grid view</div>
                <div class="desc">multi-stream grid canvas<br>swap to individual devices</div>
            </div>
            <div class="mode-card web" onclick="launchMode('web')" title="Open in browser for PWA/phone use">
                <span class="icon">◎</span>
                <div class="name">web</div>
                <div class="desc">browser PWA mode<br>phone &amp; tablet ready</div>
            </div>
        </div>

        <div class="dev-section">
            <button class="dev-btn" onclick="launchDev()" title="Open dev terminal with console">
                <span class="brace">{</span>dev<span class="brace">}</span> launch
            </button>
        </div>
    </div>

    <div class="rainbow"><span class="r1"></span><span class="r2"></span><span class="r3"></span><span class="r4"></span><span class="r5"></span><span class="r6"></span></div>

    <div id="console-panel">
        <div id="console-header" onclick="toggleConsole()">
            <span class="arrow">▾</span>
            <span>command console</span>
            <span style="flex:1"></span>
            <span id="console-count" style="color:#3fb950">0</span>
        </div>
        <div id="console-log"></div>
        <div id="console-cmd">
            <span class="prompt">▸</span>
            <input type="text" id="cmd-input" placeholder="stop all | reload <id> | feed <ip> | grid | list | help" onkeydown="if(event.key==='Enter')runCmd()">
        </div>
    </div>

    <div id="footer">
        <span>devices:</span><span class="val" id="ft-devices">0</span>
        <span>streams:</span><span class="val" id="ft-streams">0</span>
        <span>uptime:</span><span class="val" id="ft-uptime">0s</span>
        <span class="spacer"></span>
        <span class="version">uvspeed v4.0</span>
    </div>
</div>

<script>
'use strict';

const IS_TAURI = !!window.__TAURI__;
const startTime = Date.now();

// ── Starfield (titlebar + main) ──
function initStarfield(cvs, count) {
    if (!cvs) return;
    const ctx = cvs.getContext('2d');
    const stars = [];
    function resize() {
        cvs.width = cvs.parentElement.offsetWidth;
        cvs.height = cvs.parentElement.offsetHeight;
    }
    resize();
    window.addEventListener('resize', resize);
    for (let i = 0; i < count; i++) {
        stars.push({
            x: Math.random() * 2000, y: Math.random() * 800,
            r: Math.random() * 1.2 + 0.2, a: Math.random() * 0.6 + 0.15,
            tw: Math.random() * 2 + 0.5, ph: Math.random() * Math.PI * 2,
        });
    }
    function draw() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        const t = Date.now() / 1000;
        for (const s of stars) {
            const alpha = 0.15 + 0.85 * s.a * (0.5 + 0.5 * Math.sin(t * s.tw + s.ph));
            ctx.fillStyle = `rgba(255,255,255,${alpha})`;
            ctx.beginPath();
            ctx.arc(s.x % cvs.width, s.y % cvs.height, s.r, 0, Math.PI * 2);
            ctx.fill();
        }
        requestAnimationFrame(draw);
    }
    draw();
}
initStarfield(document.getElementById('titlebar-stars'), 40);
initStarfield(document.getElementById('main-stars'), 100);

// ── BroadcastChannel for device count + command routing ──
const bc = new BroadcastChannel('hexterm');
const _devices = {};   // feedId → { src, status, fps, lastSeen }

bc.onmessage = (evt) => {
    const msg = evt.data;
    if (!msg || !msg.type) return;

    if (msg.type === 'feed-open') {
        _devices[msg.feedId] = { src: msg.src || '?', status: 'active', fps: 0, lastSeen: Date.now() };
        clog(`<span class="ok">+</span> feed opened: ${msg.feedId} (${msg.src || 'unknown'})`);
    }
    if (msg.type === 'feed-close') {
        if (_devices[msg.feedId]) _devices[msg.feedId].status = 'closed';
        clog(`feed closed: ${msg.feedId}`);
    }
    if (msg.type === 'feed-stats') {
        if (!_devices[msg.feedId]) _devices[msg.feedId] = { src: msg.src, status: 'active', fps: 0, lastSeen: Date.now() };
        _devices[msg.feedId].fps = msg.fps || 0;
        _devices[msg.feedId].lastSeen = Date.now();
        _devices[msg.feedId].status = 'active';
    }
    if (msg.type === 'feed-status') {
        if (_devices[msg.feedId]) {
            _devices[msg.feedId].status = msg.status;
            _devices[msg.feedId].lastSeen = Date.now();
        }
    }
    if (msg.type === 'transcript' && msg.watchHit) {
        clog(`<span style="color:#ffe138">WATCH</span> [${msg.feedId}] ${msg.text}`);
    }
    if (msg.type === 'grid-stats') {
        // Grid window reporting aggregate stats
    }
};

// ── Console log ──
const consoleLog = document.getElementById('console-log');
let consoleLineCount = 0;
let consoleCollapsed = false;

function clog(html) {
    const line = document.createElement('div');
    const t = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    line.innerHTML = `<span class="ts">${t}</span> ${html}`;
    consoleLog.appendChild(line);
    if (consoleLog.children.length > 200) consoleLog.removeChild(consoleLog.firstChild);
    consoleLog.scrollTop = consoleLog.scrollHeight;
    consoleLineCount++;
    document.getElementById('console-count').textContent = consoleLineCount;
}

function toggleConsole() {
    consoleCollapsed = !consoleCollapsed;
    const header = document.getElementById('console-header');
    consoleLog.style.display = consoleCollapsed ? 'none' : '';
    document.getElementById('console-cmd').style.display = consoleCollapsed ? 'none' : '';
    header.classList.toggle('collapsed', consoleCollapsed);
}

// ── Device count helpers ──
function countDevices() {
    let active = 0, idle = 0, offline = 0;
    const now = Date.now();
    for (const [id, d] of Object.entries(_devices)) {
        if (d.status === 'closed') { offline++; continue; }
        if (now - d.lastSeen > 15000) { idle++; continue; }
        active++;
    }
    return { active, idle, offline, total: active + idle + offline };
}

// ── Footer updates ──
setInterval(() => {
    const c = countDevices();
    document.getElementById('ft-devices').textContent = c.active + '/' + c.total;
    document.getElementById('ft-streams').textContent = c.active;
    const secs = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('ft-uptime').textContent = secs < 60 ? secs + 's' : Math.floor(secs / 60) + 'm';
}, 2000);

// ── Command runner ──
function runCmd() {
    const input = document.getElementById('cmd-input');
    const raw = input.value.trim();
    if (!raw) return;
    input.value = '';
    clog(`<span class="cmd">▸</span> ${raw}`);

    const [cmd, ...rest] = raw.split(/\s+/);
    const arg = rest.join(' ');

    switch (cmd) {
        case 'help':
            clog('  <span class="cmd">list</span>              — list connected devices');
            clog('  <span class="cmd">stop &lt;id|all&gt;</span>    — close feed(s)');
            clog('  <span class="cmd">reload &lt;id|all&gt;</span>  — force reload window(s)');
            clog('  <span class="cmd">feed &lt;ip&gt;</span>        — open feed window to IP');
            clog('  <span class="cmd">cam [back]</span>        — open camera feed');
            clog('  <span class="cmd">grid</span>              — open grid view');
            clog('  <span class="cmd">terminal</span>          — open terminal instance');
            clog('  <span class="cmd">watch &lt;phrase&gt;</span>   — set watch phrase on all feeds');
            clog('  <span class="cmd">mute &lt;id&gt;</span>        — toggle mute on a feed');
            clog('  <span class="cmd">clear</span>             — clear console log');
            break;

        case 'list':
        case 'ls':
        case 'devices': {
            const c = countDevices();
            if (c.total === 0) {
                clog('  <span style="color:#484f58">no devices connected</span>');
            } else {
                clog(`  ${c.active} active, ${c.idle} idle, ${c.offline} offline`);
                for (const [id, d] of Object.entries(_devices)) {
                    const stColor = d.status === 'closed' ? '#484f58' : d.status === 'active' ? '#3fb950' : '#d29922';
                    const age = ((Date.now() - d.lastSeen) / 1000).toFixed(0);
                    clog(`  <span style="color:#58a6ff">${id}</span> src:${d.src} <span style="color:${stColor}">${d.status}</span> fps:${d.fps} ${age}s`);
                }
            }
            break;
        }

        case 'stop':
        case 'kill':
        case 'close':
            if (arg === 'all') {
                for (const id of Object.keys(_devices)) {
                    bc.postMessage({ type: 'command', cmd: 'close', feedId: id });
                }
                clog(`<span class="ok">closing all feeds</span>`);
            } else if (arg) {
                bc.postMessage({ type: 'command', cmd: 'close', feedId: arg });
                clog(`closing: ${arg}`);
            } else {
                clog('<span class="err">usage: stop &lt;id|all&gt;</span>');
            }
            break;

        case 'reload': {
            if (arg === 'all') {
                bc.postMessage({ type: 'command', cmd: 'reload-all' });
                clog('<span class="ok">reloading all windows</span>');
            } else if (arg) {
                bc.postMessage({ type: 'command', cmd: 'reload', feedId: arg });
                clog(`reloading: ${arg}`);
            } else {
                clog('<span class="err">usage: reload &lt;id|all&gt;</span>');
            }
            break;
        }

        case 'feed': {
            if (!arg) { clog('<span class="err">usage: feed &lt;ip&gt;</span>'); break; }
            const feedId = 'feed-' + Date.now() % 10000;
            let src = arg;
            if (!src.includes(':')) src += ':9876';
            if (!src.startsWith('ws://')) src = 'ws://' + src;
            if (IS_TAURI) {
                window.__TAURI__.core.invoke('open_feed', { feedId, source: src })
                    .then(() => clog(`<span class="ok">opened feed</span> ${feedId} → ${src}`))
                    .catch(e => clog(`<span class="err">error:</span> ${e}`));
            } else {
                window.open(`feed.html?id=${feedId}&src=${encodeURIComponent(src)}`, feedId, 'width=480,height=640');
                clog(`<span class="ok">opened feed</span> ${feedId}`);
            }
            break;
        }

        case 'cam':
        case 'camera': {
            const facing = (arg === 'back' || arg === 'rear') ? 'camera:back' : 'camera';
            const feedId = 'cam-' + Date.now() % 10000;
            if (IS_TAURI) {
                window.__TAURI__.core.invoke('open_feed', { feedId, source: facing })
                    .then(() => clog(`<span class="ok">opened camera</span> ${feedId}`))
                    .catch(e => clog(`<span class="err">error:</span> ${e}`));
            } else {
                window.open(`feed.html?id=${feedId}&src=${facing}`, feedId, 'width=480,height=640');
                clog(`<span class="ok">opened camera</span> ${feedId}`);
            }
            break;
        }

        case 'grid':
            launchMode('grid');
            clog('<span class="ok">opening grid view</span>');
            break;

        case 'terminal':
        case 'term':
            launchMode('instance');
            clog('<span class="ok">opening terminal</span>');
            break;

        case 'watch':
            if (arg) {
                bc.postMessage({ type: 'command', cmd: 'watch', phrases: arg.split(',').map(s => s.trim()) });
                clog(`<span class="ok">watch set:</span> ${arg}`);
            } else {
                clog('<span class="err">usage: watch &lt;phrase&gt;</span>');
            }
            break;

        case 'mute':
            if (arg) {
                bc.postMessage({ type: 'command', cmd: 'mute', feedId: arg });
                clog(`mute toggled: ${arg}`);
            } else {
                clog('<span class="err">usage: mute &lt;id&gt;</span>');
            }
            break;

        case 'clear':
            consoleLog.innerHTML = '';
            consoleLineCount = 0;
            document.getElementById('console-count').textContent = '0';
            break;

        default:
            clog(`<span class="err">unknown:</span> ${cmd} — type <span class="cmd">help</span>`);
    }
}

// Boot message
clog('<span class="ok">uvspeed launcher ready</span> — type <span class="cmd">help</span> for commands');

// ── Launch modes ──
function launchMode(mode) {
    if (IS_TAURI) {
        const invoke = window.__TAURI__.core.invoke;
        switch (mode) {
            case 'instance':
                invoke('open_window', {
                    label: 'hexterm',
                    url: 'terminal.html',
                    title: 'uvspeed — terminal',
                    device: 'ipad',
                }).then(() => {
                    // Close launcher or keep it — keep it as command center
                });
                break;
            case 'grid':
                invoke('open_window', {
                    label: 'grid-' + Date.now() % 10000,
                    url: 'grid.html',
                    title: 'uvspeed — grid',
                    device: 'desktop',
                });
                break;
            case 'web':
                // Open terminal.html in the default browser
                if (window.__TAURI__.shell) {
                    window.__TAURI__.shell.open('http://localhost:1420/terminal.html');
                } else {
                    window.open('terminal.html', '_blank');
                }
                break;
        }
    } else {
        // Browser mode
        switch (mode) {
            case 'instance':
                window.location.href = 'terminal.html';
                break;
            case 'grid':
                window.location.href = 'grid.html';
                break;
            case 'web':
                window.location.href = 'terminal.html';
                break;
        }
    }
}

function launchDev() {
    if (IS_TAURI) {
        window.__TAURI__.core.invoke('open_window', {
            label: 'dev-' + Date.now() % 10000,
            url: 'terminal.html',
            title: 'uvspeed — {dev}',
            device: 'desktop',
        }).then(() => {
            // After terminal opens, send command to open dev console
            setTimeout(() => {
                const bc2 = new BroadcastChannel('hexterm');
                bc2.postMessage({ type: 'command', cmd: 'dev-mode' });
                bc2.close();
            }, 1500);
        });
    } else {
        window.location.href = 'terminal.html?dev=1';
    }
}
</script>
</body>
</html>
