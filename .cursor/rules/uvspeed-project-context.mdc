---
alwaysApply: true
---
# UV-Speed Project Context

## Architecture

Single-page PWA apps in `web/`, each a self-contained HTML file with inline CSS + JS.
No build system — files serve directly. Shared module: `web/quantum-prefixes.js`.

## All Apps (22 HTML files in web/)

| App | File | Role |
|-----|------|------|
| Quantum Notepad | `quantum-notepad.html` | Main notebook — cells, quantum gutter, terminal, sidebar |
| HexBench | `hexbench.html` | Voltage lab — PSU, code editor (Arduino), node workbench, Pybricks builder |
| HexTerm | `terminal.html` | xterm.js terminal — quantum gutter on cat/head/tail, filesystem |
| HexCast | `hexcast.html` | Video hex broadcast — camera/screen capture, latency benchmarks |
| HexCast Send | `hexcast-send.html` | Camera → terminal streaming |
| Research Lab | `research-lab.html` | Markdown research editor with mermaid + preview |
| ArchFlow | `archflow.html` | n8n-style architecture node visualizer + mermaid export |
| GitHub Dashboard | `github-dashboard.html` | Repo dashboard — phases, deps, community, actions |
| Launcher | `launcher.html` | App launcher hub |
| Grid | `grid.html` | Multi-feed grid viewer |
| Feed | `feed.html` | Camera feed viewer |
| QuestCast | `questcast.html` | Meta Quest broadcast + research tools |
| Sponsor | `sponsor.html` | Sponsor page with Rubik's cube, starfield, tiers |
| Jawta Audio | `jawta-audio.html` | Spatial audio + live code |
| Numsy | `numsy.html` | 1080x1080 Instagram visual |
| Brother Numsy | `brothernumsy.html` | Numsy game variant |
| KBatch | `kbatch.html` | World keyboard analyzer — 15 layouts, IBM Quantum bridge, dictionary, training drills |
| Blackwell | `blackwell.html` | Blackwell GPU dashboard |
| Quantum Gutter | `quantum-gutter.html` | Prefix system showcase — 3D cube, starfield, benchmarks |
| FreyaUnits | `freya.html` | Galactic converter, calculator, celestial charts, quantum geo nav |
| Freya Landing | `freya-landing.html` | FreyaUnits showcase — log-scale canvas, live converter, roadmap |
| History | `history.html` | Universal timeline knowledge graph — ZPF to cosmic, block canvas, AI persona |
| Search | `search.html` | Mobile-first universal search PWA — 14 connectors, timeline strip |

## Browser Extension: `extensions/history-search/`

Chrome/Edge/Brave/Opera/Arc/Vivaldi/Firefox extension that injects 14-connector search above Google, Bing, DuckDuckGo, Brave Search, Ecosia, Yahoo results. Mobile devices use `search.html` PWA or HexTerm `search` command instead.

## Shared Modules

### quantum-prefixes.js

All 22 apps include `<script src="quantum-prefixes.js"></script>` and have a
`// ===== QUANTUM PREFIX LIVE SYNC =====` init block.

**API** (`window.QuantumPrefixes`):
- `classifyLine(line, language)` → `{ sym, cls, category }`
- `prefixContent(content, language)` → prefixed string
- `prefixMetadata(content, language)` → `{ coverage, totalLines, classifiedLines, prefixCounts, lines }`
- `exportWithPrefixes(content, language, source)` → `{ text, meta }`
- `downloadWithPrefixes(content, filename, language, source)` → downloads file
- `wrapJsonExport(data, contents, source)` → JSON with `quantumGutter` metadata
- `detectLanguage(content, hint)` → language string
- `broadcastState(source, state)` — sends via `BroadcastChannel('quantum-prefixes')`
- `onStateChange(fn)` — listen for cross-app state updates
- `requestStateSync()` — ask all apps to re-broadcast
- `connectIoT(wsUrl, opts)` — WebSocket bridge to IoT/quantum computer
- `aggregateGlobalStats()` — combined coverage across all running apps

**Supported languages** (17): python, javascript, typescript, rust, go, shell, c, cpp, html, css, markdown, mermaid, sql, yaml, json, arduino

### history-search-engine.js

Shared search engine used by extension + PWAs + HexTerm.

**API** (`window.HistorySearch`):
- `search(query, opts)` → `{ query, results, latencyMs, connectorsUsed, totalResults }`
- `getConnectors()` → array of `{ name, icon, enabled }`
- `setConnectorEnabled(nameOrIndex, enabled)` — toggle a connector
- `getScales()` → timeline scale definitions
- `getSourceColor(source)` → hex color
- `drawTimeline(canvas)` — render mini timeline on a canvas

**14 Connectors**: Wikipedia, Open Library, Wayback Machine, Sacred Texts, Yale Archives, ARDA, arXiv, PubChem, GenBank, LGBTQ Archives, Meta Research, HathiTrust, Internet Archive

## Cross-App Communication

- `BroadcastChannel('hexterm')` — main inter-app messaging (code, serial data, commands)
- `BroadcastChannel('quantum-prefixes')` — quantum prefix state sync
- `BroadcastChannel('hexcast-stream')` — video frame broadcast
- `BroadcastChannel('history-search')` — search engine ready/state sync
- `localStorage` — per-app persistence + `quantum-prefixes-state` for global prefix state

## Quantum Notepad Key Structure

- **Cells**: code/markdown/mermaid/visualization/kbatch/hexcast types
- **Quantum Position**: `[x, y, z]` — deps, lines, complexity
- **Sidebar**: Nav (3D cube rotation), Visual, Thermal tabs + AI/LLM, Language, Blocks ext tabs
- **Footer/Top**: Quick command tab bars (identical, duplicated)
- **Terminal Panel**: xterm.js with Problems, Output, Debug Console, Terminal, Ports, Syncing tabs
- **Quantum Heatmap**: Fullscreen overlay — treemap/bubble/bars/sunburst from `⛶` button
- **Inline methods**: `classifyLine()`, `detectCellLanguage()`, `prefixContent()`, `prefixMetadata()`, `saveNotebook()`, `_saveToLocalStorage()` — all include quantum prefix data in output

## File Export Behavior (IMPORTANT)

All saved/exported files MUST contain quantum gutter prefixes:
- **Notepad JSON save**: cells include `prefixedContent` + `quantumPrefix` metadata + global `quantumGutter` stats
- **Notepad cell export**: header with coverage stats + prefixed content
- **Notepad localStorage**: cells include per-cell `quantumPrefix` summary
- **HexBench JSON export**: `quantumGutter` metadata + `prefixedCode` field
- **Research Lab .md export**: uses `QP.downloadWithPrefixes()` for gutter header
- **Dashboard JSON export**: wrapped with `QP.wrapJsonExport()`
- **ArchFlow JSON export**: `quantumGutter` metadata + `prefixedMermaid` field

## Gold Standard Build (10 languages)

| Layer | Files | Runner |
|-------|-------|--------|
| TypeScript | `quantum-prefixes.d.ts`, `wasm-loader.ts`, `tsconfig.json` | `tsc --noEmit` |
| Rust | `crates/prefix-engine/`, `src-tauri/src/prefix_engine.rs` | `cargo test`, `cargo clippy` |
| WASM | `scripts/build-wasm.sh` → `web/wasm/` | `bash scripts/build-wasm.sh` |
| Go | `src/bridge/main.go` | `go build` |
| WGSL | `src/shaders/prefix-classify.wgsl` | WebGPU runtime |
| CSS | `web/quantum-theme.css` | Shared theme module |
| Nushell | `scripts/build.nu`, `test.nu`, `audit.nu`, `pre.nu` | `nu scripts/X.nu` |
| Shell | `scripts/pre.sh`, `build-wasm.sh`, `version-sync.sh` | `bash scripts/X.sh` |
| CI/CD | `.github/workflows/ci.yml`, `health.yml` | GitHub Actions |
| Config | `.pre-commit-config.yaml`, `.github/cliff.toml` | `pre-commit run` |

## Gold Standard Runners (ALWAYS use these)

```bash
# Pre-push checklist
nu scripts/pre.nu                    # Full audit (Nushell — fastest)
bash scripts/pre.sh pre              # Full audit (Bash)
uv run uvspeed_cli.py pre            # Full audit (Python)

# Tests
cargo test -p uvspeed-prefix-engine  # Rust tests (fastest)
uv run pytest                        # Python tests (fast via uv)

# Lint
cargo clippy -p uvspeed-prefix-engine -- -D warnings
uv run ruff check .                  # NEVER bare ruff, always uv run

# Search (NEVER grep/find)
rg "pattern"                         # ripgrep — always
fd "*.html" web/                     # fd — always
```

## Common Patterns

- `const $ = id => document.getElementById(id);` — used in hexbench, research-lab, archflow
- IIFEs wrap most app logic: `(function(){ ... })();`
- Console commands exposed via `window.appName = { ... }` API objects
- Dark theme using CSS custom properties (`--qp-*` vars, legacy `--cursor-*` mapped)
- Mobile-responsive with `@media(max-width:600px)` rules
- Quantum theme: `web/quantum-theme.css` for shared light/dark theming
